<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELT Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            font-size: 14px;
            color: #212121;
        }

        .top-bar {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.25rem;
            margin: 0;
            font-weight: 500;
            color: #212121;
            letter-spacing: 0;
        }

        .header p {
            font-size: 0.875rem;
            color: #757575;
            margin: 2px 0 0 0;
        }

        .section-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .card {
            background: #fff;
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }

        .card h2 {
            font-size: 1.125rem;
            margin-bottom: 16px;
            color: #212121;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stepper Styles */
        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 0 24px;
        }

        .step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            left: 50%;
            right: -50%;
            height: 1px;
            background: #e0e0e0;
            z-index: 0;
        }

        .step.active:not(:last-child)::after {
            background: #1976d2;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #757575;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 8px;
            z-index: 1;
            position: relative;
        }

        .step.active .step-circle {
            background: #1976d2;
            color: white;
        }

        .step.completed .step-circle {
            background: #2e7d32;
            color: white;
        }

        .step-label {
            font-size: 0.75rem;
            color: #9e9e9e;
            text-align: center;
        }

        .step.active .step-label {
            color: #1976d2;
            font-weight: 500;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        thead {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 500;
            color: #616161;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f5f5f5;
            color: #424242;
        }

        tbody tr {
            transition: background-color 0.15s ease;
        }

        tbody tr:hover {
            background: #fafafa;
        }

        .pipeline-name {
            font-weight: 500;
            color: #212121;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: #1565c0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        button:active {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            background: #e0e0e0;
            color: #9e9e9e;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-danger {
            background: #d32f2f;
        }

        .btn-danger:hover {
            background: #c62828;
        }

        .btn-success {
            background: #2e7d32;
        }

        .btn-success:hover {
            background: #1b5e20;
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 0.8125rem;
        }

        .btn-outline {
            background: transparent;
            color: #1976d2;
            border: 1px solid rgba(25, 118, 210, 0.5);
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 4px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.2s;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: white;
        }

        .modal-header h2 {
            margin: 0;
            color: #212121;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .close {
            color: #9e9e9e;
            font-size: 24px;
            font-weight: normal;
            cursor: pointer;
            line-height: 1;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close:hover {
            background: #f5f5f5;
            color: #212121;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-shrink: 0;
            background: #fafafa;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #555;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.6875rem;
            font-weight: 500;
            letter-spacing: 0.25px;
        }

        .badge-dlt {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-sling {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-enabled {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-disabled {
            background: #ffebee;
            color: #c62828;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .hidden {
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .credential-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .credential-section h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #555;
        }

        .section-divider {
            border-top: 2px dashed #e0e0e0;
            margin: 25px 0;
            padding-top: 25px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        select optgroup {
            font-weight: bold;
            font-style: normal;
            color: #000;
            background: #fff;
        }

        select optgroup option {
            font-weight: normal;
            padding-left: 20px;
            color: #000;
            background: #fff;
        }

        select option {
            color: #000;
            background: #fff;
            padding: 8px;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #bdbdbd;
            transition: .2s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        input:checked + .toggle-slider {
            background-color: #2e7d32;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-slider:hover {
            background-color: #9e9e9e;
        }

        input:checked + .toggle-slider:hover {
            background-color: #1b5e20;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                margin: 10px auto;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .top-bar {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        body.dark-mode .sidebar {
            background: #2d2d2d;
            border-right-color: #404040;
        }

        body.dark-mode .main-content {
            background: #1a1a1a;
        }

        body.dark-mode .card {
            background: #2d2d2d;
            border-color: #404040;
        }

        body.dark-mode .pipeline-card {
            background: #2d2d2d;
            border-color: #404040;
        }

        body.dark-mode .pipeline-card:hover {
            border-color: #1976d2;
            background: #353535;
        }

        body.dark-mode .modal-content {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        body.dark-mode .modal-header {
            background: #252525;
            border-bottom-color: #404040;
        }

        body.dark-mode .modal-footer {
            background: #252525;
            border-top-color: #404040;
        }

        body.dark-mode .modal-body {
            background: #2d2d2d;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #1a1a1a;
            color: #e0e0e0;
            border-color: #404040;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: #1976d2;
            background: #252525;
        }

        body.dark-mode .btn-outline {
            border-color: #404040;
            color: #e0e0e0;
        }

        body.dark-mode .btn-outline:hover {
            background: #353535;
        }

        body.dark-mode table {
            border-color: #404040;
        }

        body.dark-mode th {
            background: #353535;
            border-color: #404040;
        }

        body.dark-mode td {
            border-color: #404040;
            color: #e0e0e0;
        }

        body.dark-mode tr:hover {
            background: #252525;
        }

        body.dark-mode .pipeline-name {
            color: #e0e0e0;
        }

        body.dark-mode .badge {
            background: #353535;
            border-color: #404040;
        }

        body.dark-mode .alert {
            background: #353535;
            border-color: #404040;
        }

        body.dark-mode code {
            background: #1a1a1a;
            color: #ffa726;
        }

        body.dark-mode .close {
            color: #e0e0e0;
        }

        body.dark-mode .close:hover {
            color: #fff;
        }

        /* Fix form sections and backgrounds in dark mode */
        body.dark-mode [style*="background: #f5f5f5"],
        body.dark-mode [style*="background: #fafafa"],
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background: #fff"] {
            background: #353535 !important;
        }

        body.dark-mode [style*="background: rgba(0, 0, 0, 0.02)"] {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Checkboxes in dark mode */
        body.dark-mode input[type="checkbox"] {
            background: #1a1a1a;
            border: 1px solid #555;
            filter: invert(0.9);
        }

        /* Section dividers in dark mode */
        body.dark-mode .section-divider {
            border-top-color: #404040;
        }

        body.dark-mode hr {
            border-color: #404040;
        }

        /* Stepper in dark mode */
        body.dark-mode .stepper-step {
            background: #353535;
            border-color: #404040;
            color: #999;
        }

        body.dark-mode .stepper-step.active {
            border-color: #1976d2;
            color: #1976d2;
        }

        body.dark-mode .stepper-step.completed {
            background: #1976d2;
            color: white;
        }

        /* Tabs in dark mode */
        body.dark-mode .tab {
            background: #353535;
            border-color: #404040;
            color: #999;
        }

        body.dark-mode .tab.active {
            background: #2d2d2d;
            border-bottom-color: #2d2d2d;
            color: #e0e0e0;
        }

        /* Help text and labels in dark mode */
        body.dark-mode [style*="color: #666"],
        body.dark-mode [style*="color: #616161"],
        body.dark-mode [style*="color: #757575"] {
            color: #999 !important;
        }

        body.dark-mode [style*="color: #212121"] {
            color: #e0e0e0 !important;
        }

        /* Loading states in dark mode */
        body.dark-mode .loading {
            color: #999;
        }

        /* Headings in dark mode */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #e0e0e0;
        }

        /* Fix specific inline colored text in dark mode */
        body.dark-mode [style*="color: #333"],
        body.dark-mode [style*="color: #555"] {
            color: #e0e0e0 !important;
        }

        /* Git status boxes and info sections */
        body.dark-mode [style*="background: #e8f5e9"],
        body.dark-mode [style*="background: #fff3e0"],
        body.dark-mode [style*="background: #ffebee"] {
            background: #2a3a2a !important;
            border-color: #4a5a4a !important;
        }

        body.dark-mode [style*="border-left: 3px solid #1976d2"] {
            border-left-color: #1976d2 !important;
        }

        body.dark-mode [style*="border-left: 3px solid #4caf50"] {
            border-left-color: #4caf50 !important;
        }

        body.dark-mode [style*="border-left: 3px solid #f44336"] {
            border-left-color: #f44336 !important;
        }

        /* Icon mode - hide text labels, show icons */
        .action-icon {
            display: none;
        }

        .action-text {
            display: inline;
        }

        body.icon-mode .action-icon {
            display: inline;
        }

        body.icon-mode .action-text {
            display: none;
        }

        body.icon-mode button {
            min-width: auto;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div style="max-width: 1400px; margin: 0 auto;">
            <div class="header">
                <div>
                    <h1>ELT Pipeline Manager</h1>
                    <p>Manage dlt and Sling pipelines</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button id="gitSyncBtn" onclick="syncFromGitHub()" class="btn-primary" style="text-transform: none; display: none;">
                        ‚¨áÔ∏è Pull from GitHub (<span id="commitsBehind">0</span>)
                    </button>
                    <button onclick="openCreatePipelineModal()" class="btn-success" style="text-transform: none;" title="Create new pipeline">
                        <span class="action-icon">+</span><span class="action-text">New Pipeline</span>
                    </button>
                    <button onclick="openEnvModal()" class="btn-outline" style="text-transform: none;" title="Manage environment variables">
                        <span class="action-icon">$</span><span class="action-text">Environment Variables</span>
                    </button>
                    <button onclick="openGitModal()" class="btn-outline" style="text-transform: none;" title="Git operations">
                        <span class="action-icon">‚éá</span><span class="action-text">Git</span>
                    </button>
                    <button onclick="openCredentialsModal()" class="btn-outline" style="text-transform: none;" title="Test credentials">
                        <span class="action-icon">‚óà</span><span class="action-text">Credentials</span>
                    </button>
                    <button onclick="openSettingsModal()" class="btn-outline" style="text-transform: none;" title="Application settings">
                        <span class="action-icon">‚öô</span><span class="action-text">Settings</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Pipelines List -->
        <div class="card">
            <h2>Pipelines</h2>
            <div id="pipelinesContainer">
                <div class="loading">Loading pipelines...</div>
            </div>
        </div>

        <!-- Git Status -->
        <div class="card">
            <h2>Git Status</h2>
            <div id="gitStatus">
                <div class="loading">Checking git status...</div>
            </div>
        </div>
    </div>

    <!-- Create Pipeline Modal -->
    <div id="createPipelineModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="pipelineModalTitle">Create New Pipeline</h2>
                <span class="close" onclick="closeModal('createPipelineModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Stepper -->
                <div class="stepper">
                    <div class="step active" data-step="1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Source & Destination</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Credentials</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Schedule</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Metadata</div>
                    </div>
                </div>

                <form id="createPipelineForm">
                    <!-- Step 1: Source & Destination -->
                    <div class="step-content active" data-step="1">
                        <div class="grid">
                            <div class="form-group">
                                <label for="pipelineName">Pipeline Name *</label>
                                <input type="text" id="pipelineName" name="name" required placeholder="my_pipeline">
                            </div>

                            <div class="form-group">
                                <label for="description">Description</label>
                                <input type="text" id="description" name="description" placeholder="Load data from source to destination">
                            </div>
                        </div>

                        <div class="grid">
                            <div class="form-group">
                                <label for="sourceType">Source Type *</label>
                                <select id="sourceType" name="source_type" required>
                                    <option value="">-- Select Source --</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="destinationType">Destination Type *</label>
                                <select id="destinationType" name="destination_type" required>
                                    <option value="">-- Select Destination --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Source Configuration -->
                        <div id="sourceConfigFields" class="hidden section-divider"></div>

                        <!-- Write Disposition Configuration -->
                        <div class="section-divider">
                            <h3 style="margin-bottom: 15px;">Data Loading Strategy</h3>
                            <div class="form-group">
                                <label for="writeDisposition">Write Disposition</label>
                                <select id="writeDisposition" name="writeDisposition" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;" onchange="updateWriteDispositionUI()">
                                    <option value="append">Append - Add new rows (incremental loading)</option>
                                    <option value="replace">Replace - Full refresh (drop and reload)</option>
                                    <option value="merge">Merge - Upsert using primary key</option>
                                </select>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Choose how data should be loaded into the destination
                                </p>
                            </div>

                            <!-- Merge configuration (shown only when merge is selected) -->
                            <div id="mergeConfiguration" style="display: none;">
                                <div class="form-group">
                                    <label for="primaryKey">Primary Key</label>
                                    <input type="text" id="primaryKey" name="primaryKey" placeholder="id" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                        Column name to use as primary key for merge/upsert operations
                                    </p>
                                </div>
                                <div class="form-group">
                                    <label for="mergeKey">Merge Key (optional)</label>
                                    <input type="text" id="mergeKey" name="mergeKey" placeholder="id" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                        Alternative key for merge operations (if different from primary key)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Incremental Loading Configuration (Creates Partitioned Assets) -->
                        <div class="section-divider">
                            <h3 style="margin-bottom: 15px;">üìÖ Incremental Loading (Partitioned Assets)</h3>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="incrementalEnabled" name="incrementalEnabled" onchange="updateIncrementalUI()">
                                    <label for="incrementalEnabled">Enable Incremental Loading (Creates Partitioned Assets in Dagster)</label>
                                </div>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    When enabled, creates partitioned assets in Dagster using the cursor field as the partition key. Each partition represents a time window of data.
                                </p>
                            </div>

                            <!-- Incremental configuration fields -->
                            <div id="incrementalConfiguration" style="display: none;">
                                <div class="form-group">
                                    <label for="cursorField">Cursor Field *</label>
                                    <input type="text" id="cursorField" name="cursorField" placeholder="updated_at" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                        Timestamp/datetime field used to track incremental loads. This becomes the partition key in Dagster.
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label for="cursorInitialValue">Initial Value (optional)</label>
                                    <input type="text" id="cursorInitialValue" name="cursorInitialValue" placeholder="2024-01-01T00:00:00Z" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                        Starting value for the first load (e.g., 2024-01-01T00:00:00Z). If not provided, will load all data on first run.
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label for="partitionFrequency">Partition Frequency</label>
                                    <select id="partitionFrequency" name="partitionFrequency" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="@daily">Daily (recommended)</option>
                                        <option value="@hourly">Hourly</option>
                                        <option value="@weekly">Weekly</option>
                                        <option value="@monthly">Monthly</option>
                                    </select>
                                    <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                        How frequently to create partitions in Dagster. Daily is recommended for most use cases.
                                    </p>
                                </div>

                                <div class="alert alert-info" style="margin-top: 15px;">
                                    <strong>‚ÑπÔ∏è Partitioned Assets:</strong> This will create partitioned assets in Dagster where each partition represents a time window (e.g., a day). You'll be able to materialize specific partitions or backfill historical data.
                                </div>
                            </div>
                        </div>

                        <!-- File Format & Compression (for file-based destinations) -->
                        <div class="section-divider" id="fileFormatSection" style="display: none;">
                            <h3 style="margin-bottom: 15px;">üìÑ File Format & Compression</h3>

                            <div class="form-group">
                                <label for="fileFormat">File Format</label>
                                <select id="fileFormat" name="fileFormat" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="parquet">Parquet (recommended - columnar, compressed)</option>
                                    <option value="jsonl">JSONL (JSON Lines - human readable)</option>
                                    <option value="csv">CSV (Comma-separated values)</option>
                                </select>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Parquet is recommended for analytics workloads (smaller files, faster queries)
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="compression">Compression</label>
                                <select id="compression" name="compression" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="gzip">Gzip (good balance)</option>
                                    <option value="none">None (faster writes)</option>
                                    <option value="bz2">Bzip2 (smaller files)</option>
                                    <option value="snappy">Snappy (Parquet only - fast)</option>
                                    <option value="zstd">Zstandard (best compression)</option>
                                </select>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Compression reduces storage costs at the expense of CPU time
                                </p>
                            </div>
                        </div>

                        <!-- Advanced Destination Settings (for warehouse destinations) -->
                        <div class="section-divider" id="advancedDestinationSection" style="display: none;">
                            <h3 style="margin-bottom: 15px;">‚öôÔ∏è Advanced Destination Settings</h3>
                            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                                Optional configuration for warehouse and database destinations
                            </p>

                            <div class="form-group">
                                <label for="tablePrefix">Table Prefix (optional)</label>
                                <input type="text" id="tablePrefix" name="tablePrefix" placeholder="e.g., raw_" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Prefix to add to all table names (e.g., "raw_customers")
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="tableSuffix">Table Suffix (optional)</label>
                                <input type="text" id="tableSuffix" name="tableSuffix" placeholder="e.g., _staging" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Suffix to add to all table names (e.g., "customers_staging")
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="schemaOverride">Schema Name (optional)</label>
                                <input type="text" id="schemaOverride" name="schemaOverride" placeholder="e.g., analytics, staging" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Override the default schema/dataset name
                                </p>
                            </div>

                            <div class="form-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableStaging" name="enableStaging" style="margin-right: 10px;">
                                    <span>Enable Staging Tables</span>
                                </label>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Load data into staging tables first, then merge/replace to final tables (recommended for production)
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="columnHints">Column Type Hints (optional JSON)</label>
                                <textarea
                                    id="columnHints"
                                    name="columnHints"
                                    placeholder='{"column_name": "data_type", "customer_id": "bigint", "created_at": "timestamp"}'
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; min-height: 100px; resize: vertical;"
                                ></textarea>
                                <p style="font-size: 13px; color: #666; margin-top: 5px;">
                                    Specify data types for columns in JSON format. Helps ensure correct column types in the warehouse.
                                </p>
                            </div>
                        </div>

                        <!-- Tool Recommendation -->
                        <div id="toolRecommendation" class="alert alert-info hidden">
                            <strong>Recommended Tool:</strong> <span id="recommendedTool"></span>
                        </div>
                    </div>

                    <!-- Step 2: Credentials -->
                    <div class="step-content" data-step="2">
                        <div id="credentialsInput" class="section-divider">
                            <h3 style="margin-bottom: 15px;">Enter Credentials</h3>
                            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                                These credentials will be saved to your <code>.env</code> file for testing.
                            </p>
                            <div id="sourceCredentialsFields"></div>
                            <div id="destinationCredentialsFields"></div>
                        </div>
                    </div>

                    <!-- Step 3: Schedule Configuration -->
                    <div class="step-content" data-step="3">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 15px; font-weight: bold; font-size: 1.1em;">
                                ‚è∞ Schedule Configuration
                            </label>

                        <!-- Schedule Type Selector -->
                        <div style="margin-bottom: 15px;">
                            <label for="scheduleType" style="font-weight: normal;">Schedule Type</label>
                            <select id="scheduleType" onchange="updateScheduleUI()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="preset">Common Presets</option>
                                <option value="custom">Custom Schedule</option>
                                <option value="cron">Advanced (Cron)</option>
                                <option value="manual">Manual Only (No Schedule)</option>
                            </select>
                        </div>

                        <!-- Preset Options -->
                        <div id="presetSchedule" style="display: block;">
                            <label for="schedulePreset" style="font-weight: normal;">Select Frequency</label>
                            <select id="schedulePreset" onchange="updateCronFromPreset()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">-- Choose a preset --</option>
                                <optgroup label="Common">
                                    <option value="0 * * * *">Every Hour</option>
                                    <option value="0 */2 * * *">Every 2 Hours</option>
                                    <option value="0 */6 * * *">Every 6 Hours</option>
                                    <option value="0 0 * * *">Daily at Midnight</option>
                                    <option value="0 2 * * *">Daily at 2 AM</option>
                                    <option value="0 9 * * *">Daily at 9 AM</option>
                                </optgroup>
                                <optgroup label="Weekly">
                                    <option value="0 0 * * 0">Weekly on Sunday</option>
                                    <option value="0 0 * * 1">Weekly on Monday</option>
                                    <option value="0 9 * * 1">Weekly on Monday at 9 AM</option>
                                </optgroup>
                                <optgroup label="Monthly">
                                    <option value="0 0 1 * *">Monthly on 1st at Midnight</option>
                                    <option value="0 9 1 * *">Monthly on 1st at 9 AM</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Custom Schedule Builder -->
                        <div id="customSchedule" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="font-weight: normal; font-size: 0.9em;">Frequency</label>
                                    <select id="customFrequency" onchange="updateCustomScheduleFields(); updateCronFromCustom()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="hourly">Hourly</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div id="customIntervalDiv">
                                    <label style="font-weight: normal; font-size: 0.9em;">Every</label>
                                    <select id="customInterval" onchange="updateCronFromCustom()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="6">6</option>
                                        <option value="12">12</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div id="customTimeDiv">
                                    <label style="font-weight: normal; font-size: 0.9em;">Time (24h)</label>
                                    <input type="time" id="customTime" value="02:00" onchange="updateCronFromCustom()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div id="customDayDiv" style="display: none;">
                                    <label style="font-weight: normal; font-size: 0.9em;">Day of Week</label>
                                    <select id="customDay" onchange="updateCronFromCustom()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="0">Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                </div>
                                <div id="customDateDiv" style="display: none;">
                                    <label style="font-weight: normal; font-size: 0.9em;">Day of Month</label>
                                    <select id="customDate" onchange="updateCronFromCustom()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="1">1st</option>
                                        <option value="15">15th</option>
                                        <option value="L">Last day</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Cron Expression Input -->
                        <div id="cronSchedule" style="display: none;">
                            <label for="cronExpression" style="font-weight: normal;">Cron Expression</label>
                            <input type="text" id="cronExpression" placeholder="0 2 * * *" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <small style="color: #666; font-size: 0.85em;">Format: minute hour day month weekday</small>
                        </div>

                        <!-- Manual Only Message -->
                        <div id="manualSchedule" style="display: none;">
                            <p style="color: #666; padding: 15px; background: #f9f9f9; border-radius: 4px; margin: 0;">
                                Pipeline will only run when manually triggered
                            </p>
                        </div>

                        <!-- Generated Cron Display -->
                        <div id="generatedCronDisplay" style="margin-top: 15px; padding: 10px; background: #f0f7ff; border-left: 3px solid #667eea; border-radius: 4px; display: none;">
                            <small style="color: #666; font-weight: bold;">Generated Cron:</small>
                            <code id="generatedCronValue" style="margin-left: 10px; color: #667eea;"></code>
                        </div>

                            <!-- Hidden field for form submission -->
                            <input type="hidden" id="finalCronSchedule" name="cron_schedule">
                        </div>
                    </div>

                    <!-- Step 4: Metadata -->
                    <div class="step-content" data-step="4">
                        <div class="form-group">
                            <label for="groupName">Dagster Asset Group</label>
                            <input type="text" id="groupName" name="group_name" placeholder="default" style="padding: 10px; font-size: 0.9em;">
                            <small style="color: #666; font-size: 0.85em;">Group name for organizing assets in Dagster</small>
                        </div>

                        <div class="form-group">
                            <label for="ownersInput">Owners (comma-separated emails)</label>
                            <input type="text" id="ownersInput" name="owners" placeholder="data-team@company.com, eng@company.com" style="padding: 10px; font-size: 0.9em;">
                            <small style="color: #666; font-size: 0.85em;">Team or individual email addresses</small>
                        </div>

                        <!-- Kinds -->
                        <div class="form-group">
                            <label>
                                Kinds
                                <a href="https://docs.dagster.io/guides/build/assets/metadata-and-tags/kind-tags#supported-icons" target="_blank" style="font-size: 0.8em; color: #1976d2; text-decoration: none; margin-left: 4px;">‚ÑπÔ∏è View all kinds</a>
                            </label>
                            <small style="color: #666; font-size: 0.85em; display: block; margin-bottom: 8px;">
                                Kinds help categorize assets and display appropriate icons in Dagster UI
                            </small>
                            <div id="kindsList" style="display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: #f8fafc; border: 1px solid #e0e0e0; border-radius: 4px; min-height: 50px;">
                                <!-- Kinds will be added here dynamically -->
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="newKindInput" placeholder="e.g., postgres, snowflake, dbt" style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                                <button type="button" onclick="addKind()" class="btn-outline" style="white-space: nowrap; padding: 8px 16px;">Add Kind</button>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="form-group">
                            <label>Tags</label>
                            <small style="color: #666; font-size: 0.85em; display: block; margin-bottom: 8px;">
                                Key-value pairs for filtering and organization
                            </small>
                            <div id="tagsList" style="display: flex; flex-direction: column; gap: 8px; padding: 10px; background: #f8fafc; border: 1px solid #e0e0e0; border-radius: 4px; min-height: 50px;">
                                <!-- Tags will be added here dynamically -->
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="newTagKey" placeholder="Key (e.g., team)" style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                                <input type="text" id="newTagValue" placeholder="Value (e.g., data-engineering)" style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                                <button type="button" onclick="addTag()" class="btn-outline" style="white-space: nowrap; padding: 8px 16px;">Add Tag</button>
                            </div>
                        </div>

                        <!-- Retry Policy -->
                        <div class="form-group">
                            <label style="font-weight: bold; font-size: 1em; margin-bottom: 12px; display: block;">Retry Policy</label>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                <div>
                                    <label for="retries" style="font-size: 0.875rem; color: #616161; margin-bottom: 4px; display: block;">Max Retries</label>
                                    <input type="number" id="retries" name="retries" min="0" max="10" value="2" placeholder="2" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                                    <small style="color: #666; font-size: 0.8em;">Number of retry attempts</small>
                                </div>

                                <div>
                                    <label for="retryDelay" style="font-size: 0.875rem; color: #616161; margin-bottom: 4px; display: block;">Initial Delay (seconds)</label>
                                    <input type="number" id="retryDelay" name="retry_delay" min="0" value="30" placeholder="30" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                                    <small style="color: #666; font-size: 0.8em;">Wait time before first retry</small>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label for="retryBackoff" style="font-size: 0.875rem; color: #616161; margin-bottom: 4px; display: block;">Backoff Strategy</label>
                                    <select id="retryBackoff" name="retry_backoff" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="LINEAR">Linear (constant delay)</option>
                                        <option value="EXPONENTIAL">Exponential (2^n * delay)</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.8em;">How delay increases per retry</small>
                                </div>

                                <div>
                                    <label for="retryJitter" style="font-size: 0.875rem; color: #616161; margin-bottom: 4px; display: block;">Jitter</label>
                                    <select id="retryJitter" name="retry_jitter" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
                                        <option value="">None</option>
                                        <option value="FULL">Full (0 to calculated delay)</option>
                                        <option value="PLUS_MINUS">Plus/Minus (¬±delay)</option>
                                    </select>
                                    <small style="color: #666; font-size: 0.8em;">Random variation in delay</small>
                                </div>
                            </div>

                            <div style="margin-top: 12px; padding: 12px; background: #e3f2fd; border-left: 3px solid #1976d2; border-radius: 4px;">
                                <small style="color: #1565c0; font-size: 0.85em;">
                                    <strong>‚ÑπÔ∏è Retry Examples:</strong><br>
                                    ‚Ä¢ Linear with 30s delay: 30s, 30s, 30s...<br>
                                    ‚Ä¢ Exponential with 30s delay: 30s, 60s, 120s, 240s...<br>
                                    ‚Ä¢ With jitter: adds randomness to prevent thundering herd
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('createPipelineModal')" class="btn-outline">Cancel</button>
                <div style="display: flex; gap: 8px;">
                    <button type="button" id="prevBtn" onclick="prevStep()" class="btn-outline" style="display: none;">Back</button>
                    <button type="button" id="nextBtn" onclick="nextStepOrSubmit()" class="btn-success">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Git Operations Modal -->
    <div id="gitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîÑ Git Operations</h2>
                <span class="close" onclick="closeModal('gitModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="gitModalStatus"></div>

                <div class="form-group">
                    <label style="font-size: 0.95em; color: #64748b; margin-bottom: 12px;">Repository Status</label>
                    <div id="gitModalDetails" style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        Loading...
                    </div>
                </div>

                <!-- Uncommitted Changes Section -->
                <div id="gitDiffSection" class="form-group" style="display: none;">
                    <label style="font-size: 0.95em; color: #64748b; margin-bottom: 12px;">
                        üìù Uncommitted Changes
                        <button onclick="loadGitDiff()" class="btn-outline" style="font-size: 0.85em; padding: 4px 12px; margin-left: 8px;">Refresh</button>
                    </label>
                    <div id="gitDiffContent" style="background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: 'Monaco', 'Courier New', monospace; font-size: 0.85em; white-space: pre-wrap; line-height: 1.5;">
                        Loading diff...
                    </div>
                </div>

                <!-- Commit Message Section -->
                <div id="gitCommitSection" class="form-group" style="display: none;">
                    <label for="gitCommitMessage" style="font-size: 0.95em; color: #64748b; margin-bottom: 8px;">Commit Message</label>
                    <textarea id="gitCommitMessage" rows="3" placeholder="Describe your changes..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9em; resize: vertical;"></textarea>
                </div>

                <!-- Actions Section -->
                <div id="gitActionsSection" class="form-group" style="display: none;">
                    <label style="font-size: 0.95em; color: #64748b; margin-bottom: 12px;">Actions</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <button onclick="gitCommitWithMessage()" class="btn-success" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 1.2em;">üíæ</span>
                            <span>Commit</span>
                        </button>
                        <button onclick="gitPush()" style="background: #667eea; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <span style="font-size: 1.2em;">‚¨ÜÔ∏è</span>
                            <span>Push</span>
                        </button>
                        <button onclick="gitRevert()" class="btn-outline" style="display: flex; align-items: center; justify-content: center; gap: 8px; color: #dc2626; border-color: #dc2626;">
                            <span style="font-size: 1.2em;">‚Ü©Ô∏è</span>
                            <span>Revert All</span>
                        </button>
                    </div>
                </div>

                <!-- Commit History Section -->
                <div class="form-group" style="margin-top: 24px;">
                    <label style="font-size: 0.95em; color: #64748b; margin-bottom: 12px;">
                        üìú Recent Commits
                        <button onclick="loadGitHistory()" class="btn-outline" style="font-size: 0.85em; padding: 4px 12px; margin-left: 8px;">Refresh</button>
                    </label>
                    <div id="gitHistoryContent" style="background: #f8fafc; border-radius: 8px; max-height: 250px; overflow-y: auto;">
                        Loading commit history...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('gitModal')" class="btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Environment Variables Modal -->
    <div id="envModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Environment Variables</h2>
                <span class="close" onclick="closeModal('envModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #616161; margin-bottom: 16px; font-size: 0.875rem;">
                    Manage environment variables for your pipelines. Variables are stored in <code>.env</code> file.
                </p>

                <!-- Add New Variable -->
                <div style="background: #f5f5f5; padding: 16px; border-radius: 4px; margin-bottom: 20px;">
                    <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 500;">Add Variable</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 8px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8125rem;">Key</label>
                            <input type="text" id="newEnvKey" placeholder="API_KEY" style="padding: 8px 12px; font-size: 0.875rem;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.8125rem;">Value</label>
                            <input type="text" id="newEnvValue" placeholder="your-api-key" style="padding: 8px 12px; font-size: 0.875rem;">
                        </div>
                        <button onclick="addEnvVar()" class="btn-success" style="padding: 8px 16px;">
                            Add
                        </button>
                    </div>
                </div>

                <!-- Variables List -->
                <div style="margin-bottom: 20px;">
                    <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 500;">Current Variables</h3>
                    <div id="envVarsList" style="max-height: 300px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: #9e9e9e;">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Dagster+ Sync -->
                <div style="background: #e3f2fd; padding: 16px; border-radius: 4px; border-left: 4px solid #1976d2;">
                    <h3 style="font-size: 0.9375rem; margin-bottom: 12px; font-weight: 500; color: #1565c0;">
                        Sync to Dagster+
                    </h3>
                    <p style="color: #424242; margin-bottom: 12px; font-size: 0.8125rem;">
                        Define separate values for each Dagster+ environment.
                    </p>

                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.8125rem; color: #616161; display: block; margin-bottom: 8px;">Select variable to configure:</label>
                        <select id="dagsterVarSelect" onchange="showDagsterValueInputs()" style="width: 100%; padding: 8px; border: 1px solid #bdbdbd; border-radius: 4px; font-size: 0.875rem;">
                            <option value="">-- Select a variable --</option>
                        </select>
                    </div>

                    <div id="dagsterValueInputs" style="display: none;">
                        <div style="background: white; padding: 16px; border-radius: 4px; margin-bottom: 12px;">
                            <p style="color: #616161; font-size: 0.8125rem; margin-bottom: 12px;">
                                Specify different values for each deployment environment:
                            </p>

                            <div style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="syncFullDeployment" checked>
                                    <span style="font-weight: 500; font-size: 0.875rem;">Full Deployment (Production)</span>
                                </label>
                                <input type="text" id="fullDeploymentValue" placeholder="production-api-key"
                                    style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 12px;">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="checkbox" id="syncBranchDeployments">
                                    <span style="font-weight: 500; font-size: 0.875rem;">Branch Deployments (Staging)</span>
                                </label>
                                <input type="text" id="branchDeploymentsValue" placeholder="staging-api-key"
                                    style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                            </div>

                            <div style="margin-bottom: 12px;">
                                <label style="font-size: 0.8125rem; color: #616161; display: block; margin-bottom: 4px;">Code Location (Optional)</label>
                                <input type="text" id="dagsterCodeLocation" placeholder="my-code-location"
                                    style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.875rem;">
                            </div>
                        </div>

                        <button onclick="syncSingleVarToDagsterPlus()" style="background: #1976d2; padding: 8px 16px; width: 100%;">
                            Sync Variable to Dagster+
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('envModal')" class="btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Test Credentials Modal -->
    <div id="credentialsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Test Credentials</h2>
                <span class="close" onclick="closeModal('credentialsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">
                    Enter credentials to test your connections. These are stored in your <code>.env</code> file.
                </p>

                <div class="form-group">
                    <label for="testSourceType">Select Source/Destination</label>
                    <select id="testSourceType" onchange="loadCredentialFields()">
                        <option value="">-- Select --</option>
                    </select>
                </div>

                <div id="credentialFields"></div>

                <div id="testResult" class="hidden" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('credentialsModal')" class="btn-outline">Close</button>
                <button type="button" onclick="testCredentials()" class="btn-success">Test Connection</button>
            </div>
        </div>
    </div>

    <!-- Edit Metadata Modal -->
    <div id="editMetadataModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="metadataModalTitle">Edit Pipeline Metadata</h2>
                <span class="close" onclick="closeModal('editMetadataModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editMetadataForm">
                    <input type="hidden" id="metadataTool" name="metadataTool">
                    <input type="hidden" id="metadataPipelineName" name="metadataPipelineName">

                    <div class="form-group">
                        <label for="metadataEnabled">
                            <input type="checkbox" id="metadataEnabled" name="enabled" checked>
                            Pipeline Enabled
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="metadataDescription">Description</label>
                        <textarea id="metadataDescription" name="description" rows="2" placeholder="Pipeline description"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="metadataGroupName">Asset Group</label>
                        <input type="text" id="metadataGroupName" name="group_name" placeholder="default">
                    </div>

                    <div class="form-group">
                        <label for="metadataOwners">Owners (comma-separated emails)</label>
                        <input type="text" id="metadataOwners" name="owners" placeholder="user@example.com, team@example.com">
                    </div>

                    <!-- Tags -->
                    <div class="form-group">
                        <label>Tags</label>
                        <div id="metadataTagsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 32px;">
                            <!-- Tags will be rendered here -->
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="metadataNewTagKey" placeholder="Key" style="flex: 1;">
                            <input type="text" id="metadataNewTagValue" placeholder="Value" style="flex: 1;">
                            <button type="button" onclick="addMetadataTag()" class="btn-small" style="min-width: 90px; height: 32px; padding: 6px 12px; white-space: nowrap;">Add Tag</button>
                        </div>
                    </div>

                    <!-- Kinds -->
                    <div class="form-group">
                        <label>Kinds (asset icons)</label>
                        <div id="metadataKindsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 32px;">
                            <!-- Kinds will be rendered here -->
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="metadataNewKind" placeholder="e.g., postgres, snowflake, dlt" style="flex: 1;">
                            <button type="button" onclick="addMetadataKind()" class="btn-small" style="min-width: 90px; height: 32px; padding: 6px 12px; white-space: nowrap;">Add Kind</button>
                        </div>
                    </div>

                    <!-- Retry Policy -->
                    <div class="form-group">
                        <label for="metadataRetries">Max Retries</label>
                        <input type="number" id="metadataRetries" name="retries" min="0" max="10" value="2" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                    </div>

                    <div class="form-group">
                        <label for="metadataRetryDelay">Retry Delay (seconds)</label>
                        <input type="number" id="metadataRetryDelay" name="retry_delay" min="0" value="30" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                    </div>

                    <div class="form-group">
                        <label for="metadataRetryBackoff">Backoff Strategy</label>
                        <select id="metadataRetryBackoff" name="retry_backoff" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
                            <option value="LINEAR">Linear (constant delay)</option>
                            <option value="EXPONENTIAL">Exponential (2^n * delay)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="metadataRetryJitter">Jitter Strategy</label>
                        <select id="metadataRetryJitter" name="retry_jitter" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
                            <option value="">None</option>
                            <option value="FULL">Full (0 to calculated delay)</option>
                            <option value="PLUS_MINUS">Plus/Minus (¬±delay)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('editMetadataModal')" class="btn-outline">Cancel</button>
                <button type="button" onclick="saveMetadata()" class="btn-success">Save Metadata</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label style="font-weight: bold; font-size: 1.1em;">Repository Path</label>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 12px;">
                        Select the directory containing your ELT pipelines. This is where your pipeline configurations are stored.
                    </p>

                    <!-- Current path display -->
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 12px; border-left: 3px solid #1976d2;">
                        <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Current Repository:</div>
                        <div id="currentRepoPath" style="font-family: monospace; font-size: 0.9em; word-break: break-all;"></div>
                        <div id="currentRepoInfo" style="font-size: 0.85em; color: #666; margin-top: 6px;"></div>
                    </div>

                    <!-- Path browser -->
                    <div style="border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 12px;">
                        <!-- Breadcrumb -->
                        <div id="pathBreadcrumb" style="padding: 10px; background: #fafafa; border-bottom: 1px solid #e0e0e0; font-size: 0.9em; overflow-x: auto; white-space: nowrap;"></div>

                        <!-- Directory list -->
                        <div id="directoryList" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #999;">
                                Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Manual path input -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.9em; color: #666; margin-bottom: 4px; display: block;">Or enter path manually:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="manualRepoPath" placeholder="/path/to/your/pipelines" style="flex: 1; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-family: monospace; font-size: 0.9em;">
                            <button type="button" onclick="validateManualPath()" class="btn-outline" style="white-space: nowrap;">Validate</button>
                        </div>
                        <div id="manualPathValidation" style="margin-top: 6px; font-size: 0.85em;"></div>
                    </div>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

                <!-- UI Preferences -->
                <div class="form-group">
                    <label style="font-weight: bold; font-size: 1.1em;">UI Preferences</label>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 16px;">
                        Customize the appearance and behavior of the interface.
                    </p>

                    <!-- Dark Mode -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f5f5f5; border-radius: 4px; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">‚òæ Dark Mode</div>
                            <div style="font-size: 0.85em; color: #666;">Switch to a dark color scheme</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <!-- Icon Mode -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f5f5f5; border-radius: 4px;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">‚óÜ Use Icons</div>
                            <div style="font-size: 0.85em; color: #666;">Show icons instead of text labels for actions</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="iconModeToggle" onchange="toggleIconMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeModal('settingsModal')" class="btn-outline">Cancel</button>
                <button type="button" onclick="applyRepoPath()" class="btn-success">Apply & Reload</button>
            </div>
        </div>
    </div>

    <script>
        console.log('ELT Builder JavaScript loaded');

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready, initializing...');
            initializeApp();
        });

        function initializeApp() {

        // Source and destination groups (keep const for local use)
        const SOURCE_GROUPS = {
            "APIs & SaaS": ["github", "stripe", "shopify", "salesforce", "hubspot", "slack", "notion", "airtable", "zendesk", "jira", "google_analytics", "facebook_ads", "google_ads", "intercom", "mixpanel", "segment", "asana"],
            "Databases": ["postgres", "mysql", "mongodb", "duckdb", "sqlite"],
            "Cloud Storage": ["s3", "gcs", "azure_blob"],
            "Files": ["csv", "json", "parquet"]
        };

        const DESTINATION_GROUPS = {
            "Cloud Warehouses": ["snowflake", "bigquery", "redshift", "databricks"],
            "Databases": ["postgres", "mysql", "duckdb", "motherduck", "clickhouse", "sqlite"],
            "Storage": ["filesystem"]
        };

        // API helpers
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    let errorMessage = 'API request failed';
                    try {
                        const error = await response.json();
                        // Handle both simple string details and complex validation errors
                        if (typeof error.detail === 'string') {
                            errorMessage = error.detail;
                        } else if (Array.isArray(error.detail)) {
                            // Pydantic validation errors are arrays
                            errorMessage = error.detail.map(err =>
                                `${err.loc.join('.')}: ${err.msg}`
                            ).join('\n');
                        } else if (error.detail) {
                            errorMessage = JSON.stringify(error.detail, null, 2);
                        }
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                return await response.json();
            } catch (error) {
                // Only show alert for critical errors (like pipeline creation)
                // Let individual functions handle display for loading errors
                if (options.showAlert !== false) {
                    showAlert(error.message, 'error');
                }
                throw error;
            }
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const container = document.getElementById('alertContainer');
            container.appendChild(alertDiv);

            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'createPipelineModal') {
                resetStepper();
            }
        }

        // Track if we're editing vs creating
        let editingPipeline = null;

        function openCreatePipelineModal() {
            editingPipeline = null;
            document.getElementById('createPipelineForm').reset();
            document.getElementById('sourceConfigFields').classList.add('hidden');
            document.getElementById('toolRecommendation').classList.add('hidden');
            document.getElementById('sourceCredentialsFields').innerHTML = '';
            document.getElementById('destinationCredentialsFields').innerHTML = '';
            document.getElementById('pipelineModalTitle').textContent = 'Create New Pipeline';
            // Clear tags and kinds for new pipeline
            window.pipelineTags = {};
            window.pipelineKinds = [];
            renderTags();
            renderKinds();
            resetStepper();
            openModal('createPipelineModal');
        }

        async function editPipeline(tool, name) {
            try {
                // Get pipeline details
                const pipelines = await apiCall('/api/pipelines', { showAlert: false });
                const pipeline = [...pipelines.dlt, ...pipelines.sling].find(p => p.name === name && p.tool === tool);

                if (!pipeline) {
                    showAlert('Pipeline not found', 'error');
                    return;
                }

                // Store edit mode
                editingPipeline = { tool, name };

                // Populate basic form fields
                document.querySelector('input[name="name"]').value = pipeline.name;
                document.querySelector('input[name="name"]').disabled = true; // Can't change name
                document.querySelector('select[name="source_type"]').value = pipeline.source;
                document.querySelector('select[name="destination_type"]').value = pipeline.destination;
                document.querySelector('input[name="description"]').value = pipeline.description || '';
                document.querySelector('input[name="group_name"]').value = pipeline.group || '';

                // Populate metadata fields
                const ownersInput = document.querySelector('input[name="owners"]');
                if (ownersInput && pipeline.owners) {
                    ownersInput.value = Array.isArray(pipeline.owners) ? pipeline.owners.join(', ') : pipeline.owners;
                }

                // Populate tags in the new UI
                window.pipelineTags = pipeline.tags || {};
                renderTags();

                // Populate kinds in the new UI
                window.pipelineKinds = pipeline.kinds || [];
                renderKinds();

                // Populate retry policy fields
                document.querySelector('input[name="retries"]').value = pipeline.retries || 2;
                document.querySelector('input[name="retry_delay"]').value = pipeline.retry_delay || 30;
                document.querySelector('select[name="retry_backoff"]').value = pipeline.retry_backoff || 'LINEAR';
                document.querySelector('select[name="retry_jitter"]').value = pipeline.retry_jitter || '';

                // Load source configuration fields (this creates the DOM elements)
                await loadSourceConfiguration(pipeline.source);

                // Load credential input fields for the source and destination
                await loadCredentialInputFields(pipeline.source, pipeline.destination);

                // Wait a tick for DOM to update
                await new Promise(resolve => setTimeout(resolve, 100));

                // Now populate source config values
                if (pipeline.config) {
                    console.log('Populating config fields with:', pipeline.config);
                    for (const [key, value] of Object.entries(pipeline.config)) {
                        // Try multiple selectors to find the field
                        let fields = document.querySelectorAll(`[name="config_${key}"]`);

                        if (fields.length === 0) {
                            console.warn(`No field found for config_${key}`);
                            continue;
                        }

                        if (Array.isArray(value)) {
                            // Handle array values (checkboxes/multiselect)
                            value.forEach(v => {
                                const checkbox = document.querySelector(`[name="config_${key}"][value="${v}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                } else {
                                    console.warn(`Checkbox not found for config_${key} value ${v}`);
                                }
                            });
                        } else if (fields[0].type === 'checkbox') {
                            // Handle boolean checkbox
                            fields[0].checked = !!value;
                        } else {
                            // Handle text/textarea/select fields
                            fields[0].value = value;
                        }
                    }
                }

                // Update modal title
                document.getElementById('pipelineModalTitle').textContent = 'Edit Pipeline';

                resetStepper();
                openModal('createPipelineModal');

            } catch (error) {
                console.error('Error loading pipeline for edit:', error);
                showAlert('Failed to load pipeline details', 'error');
            }
        }

        async function openGitModal() {
            openModal('gitModal');
            await loadGitStatusInModal();
        }

        async function openCredentialsModal() {
            openModal('credentialsModal');
            await loadCredentialOptions();
        }

        async function openEnvModal() {
            openModal('envModal');
            await loadEnvVars();
        }

        async function openSettingsModal() {
            openModal('settingsModal');
            await loadRepoPathSettings();

            // Load UI preferences into toggles
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const iconMode = localStorage.getItem('iconMode') === 'true';
            document.getElementById('darkModeToggle').checked = darkMode;
            document.getElementById('iconModeToggle').checked = iconMode;
        }

        // Repository Path Settings Management
        let currentBrowsePath = null;
        let selectedRepoPath = null;

        async function loadRepoPathSettings() {
            try {
                const data = await apiCall('/api/config/repo-path', { showAlert: false });

                // Display current repo path
                document.getElementById('currentRepoPath').textContent = data.path;

                // Display validation info
                const infoDiv = document.getElementById('currentRepoInfo');
                const validation = data.validation;
                if (validation.valid) {
                    const pipelineCount = validation.pipeline_count || 0;
                    const gitStatus = validation.has_git ? '‚úì Git initialized' : '‚úó No Git';
                    infoDiv.innerHTML = `üì¶ ${pipelineCount} pipeline${pipelineCount !== 1 ? 's' : ''} | ${gitStatus}`;
                    infoDiv.style.color = '#2e7d32';
                } else {
                    infoDiv.textContent = validation.error || validation.warning || '';
                    infoDiv.style.color = '#d32f2f';
                }

                // Load directory browser starting from current path or home
                await browseDirectory(data.path);
            } catch (error) {
                showAlert('Failed to load repository settings', 'error');
            }
        }

        async function browseDirectory(path = null) {
            try {
                const params = path ? `?path=${encodeURIComponent(path)}` : '';
                const data = await apiCall(`/api/config/browse${params}`, { showAlert: false });

                currentBrowsePath = data.current;

                // Update breadcrumb
                const breadcrumb = document.getElementById('pathBreadcrumb');
                const parts = data.current.split('/').filter(p => p);
                let breadcrumbHtml = `<a href="#" onclick="browseDirectory('/'); return false;" style="color: #1976d2; text-decoration: none;">/</a>`;

                let accumulatedPath = '';
                parts.forEach((part, index) => {
                    accumulatedPath += '/' + part;
                    const pathToUse = accumulatedPath;
                    if (index < parts.length - 1) {
                        breadcrumbHtml += ` / <a href="#" onclick="browseDirectory('${pathToUse}'); return false;" style="color: #1976d2; text-decoration: none;">${part}</a>`;
                    } else {
                        breadcrumbHtml += ` / <strong>${part}</strong>`;
                    }
                });
                breadcrumb.innerHTML = breadcrumbHtml;

                // Update directory list
                const listDiv = document.getElementById('directoryList');
                let listHtml = '';

                // Parent directory link
                if (data.parent) {
                    listHtml += `
                        <div onclick="browseDirectory('${data.parent}')" style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                            <span style="font-size: 1.2em;">‚¨ÜÔ∏è</span>
                            <span>..</span>
                        </div>
                    `;
                }

                // Subdirectories
                if (data.directories.length === 0) {
                    listHtml += '<div style="padding: 20px; text-align: center; color: #999;">No subdirectories</div>';
                } else {
                    data.directories.forEach(dir => {
                        const icon = dir.is_elt_repo ? 'üì¶' : 'üìÅ';
                        const badge = dir.is_elt_repo ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; margin-left: 8px;">${dir.pipeline_count} pipelines</span>` : '';

                        listHtml += `
                            <div style="padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; justify-content: space-between;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                                <div onclick="browseDirectory('${dir.path}')" style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <span style="font-size: 1.2em;">${icon}</span>
                                    <span>${dir.name}</span>
                                    ${badge}
                                </div>
                                ${dir.is_elt_repo || dir.pipeline_count >= 0 ? `<button onclick="selectRepoPath('${dir.path}'); event.stopPropagation();" class="btn-small" style="padding: 4px 12px; font-size: 0.85em;">Select</button>` : ''}
                            </div>
                        `;
                    });
                }

                listDiv.innerHTML = listHtml;
            } catch (error) {
                console.error('Failed to browse directory:', error);
                showAlert('Failed to browse directory', 'error');
            }
        }

        function selectRepoPath(path) {
            selectedRepoPath = path;
            document.getElementById('manualRepoPath').value = path;
            validateManualPath();
        }

        async function validateManualPath() {
            const path = document.getElementById('manualRepoPath').value.trim();
            const validationDiv = document.getElementById('manualPathValidation');

            if (!path) {
                validationDiv.innerHTML = '';
                return;
            }

            try {
                const validation = await apiCall(`/api/config/validate?path=${encodeURIComponent(path)}`, { showAlert: false });

                if (validation.valid) {
                    selectedRepoPath = path;
                    const pipelineCount = validation.pipeline_count || 0;
                    validationDiv.innerHTML = `<span style="color: #2e7d32;">‚úì Valid path - ${pipelineCount} pipeline${pipelineCount !== 1 ? 's' : ''} found</span>`;
                } else {
                    selectedRepoPath = null;
                    validationDiv.innerHTML = `<span style="color: #d32f2f;">‚úó ${validation.error || 'Invalid path'}</span>`;
                }
            } catch (error) {
                selectedRepoPath = null;
                validationDiv.innerHTML = `<span style="color: #d32f2f;">‚úó Failed to validate path</span>`;
            }
        }

        async function applyRepoPath() {
            const path = selectedRepoPath || document.getElementById('manualRepoPath').value.trim();

            if (!path) {
                showAlert('Please select or enter a repository path', 'error');
                return;
            }

            try {
                const result = await apiCall('/api/config/repo-path', {
                    method: 'POST',
                    body: JSON.stringify({ path }),
                    showAlert: false
                });

                showAlert(`Repository path updated to: ${result.path}`, 'success');
                closeModal('settingsModal');

                // Reload the page to refresh all data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                showAlert(error.message || 'Failed to update repository path', 'error');
            }
        }

        // UI Preferences Management
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        }

        function toggleIconMode() {
            const useIcons = document.getElementById('iconModeToggle').checked;
            document.body.classList.toggle('icon-mode', useIcons);
            localStorage.setItem('iconMode', useIcons ? 'true' : 'false');
            // Re-render pipelines table to update buttons
            renderPipelinesTable();
        }

        function loadUIPreferences() {
            // Load dark mode preference
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) toggle.checked = true;
            }

            // Load icon mode preference
            const iconMode = localStorage.getItem('iconMode') === 'true';
            if (iconMode) {
                document.body.classList.add('icon-mode');
                const toggle = document.getElementById('iconModeToggle');
                if (toggle) toggle.checked = true;
            }
        }

        // Environment Variables Management
        async function loadEnvVars() {
            try {
                const data = await apiCall('/api/env', { showAlert: false });
                const container = document.getElementById('envVarsList');
                const varPipelines = data.var_pipelines || {};

                if (Object.keys(data.variables).length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #9e9e9e;">
                            No environment variables defined yet.
                        </div>
                    `;
                    const varSelect = document.getElementById('dagsterVarSelect');
                    varSelect.innerHTML = '<option value="">-- Select a variable --</option>';
                    return;
                }

                // Render variables list
                container.innerHTML = Object.entries(data.variables).map(([key, value]) => {
                    const pipelines = varPipelines[key] || [];
                    const isEmpty = value === '' || value === '********';
                    const statusBadge = isEmpty
                        ? '<span style="background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 500;">NOT SET</span>'
                        : '<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 500;">SET</span>';

                    return `
                        <div style="display: flex; justify-content: space-between; align-items: start; padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-weight: 500; color: #212121; font-size: 0.875rem;">${key}</span>
                                    ${statusBadge}
                                </div>
                                <div style="color: #757575; font-family: monospace; font-size: 0.8125rem; margin-bottom: 4px;">${value || '<empty>'}</div>
                                <div style="color: #9e9e9e; font-size: 0.75rem; margin-bottom: 4px;">Local development value</div>
                                ${pipelines.length > 0 ? `
                                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #f0f0f0;">
                                        <span style="color: #616161; font-size: 0.75rem;">Required by: </span>
                                        ${pipelines.map(p => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 4px;">${p}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editEnvVar('${key}', '${value}')" class="btn-outline btn-small" style="text-transform: none;">
                                    Edit
                                </button>
                                <button onclick="deleteEnvVar('${key}')" class="btn-danger btn-small" style="text-transform: none;">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Populate Dagster+ variable selector
                const varSelect = document.getElementById('dagsterVarSelect');
                varSelect.innerHTML = '<option value="">-- Select a variable --</option>' +
                    Object.keys(data.variables).map(key => `<option value="${key}">${key}</option>`).join('');

            } catch (error) {
                console.error('Error loading env vars:', error);
            }
        }

        function showDagsterValueInputs() {
            const select = document.getElementById('dagsterVarSelect');
            const inputsDiv = document.getElementById('dagsterValueInputs');

            if (select.value) {
                inputsDiv.style.display = 'block';
                // Clear previous values
                document.getElementById('fullDeploymentValue').value = '';
                document.getElementById('branchDeploymentsValue').value = '';
                document.getElementById('syncFullDeployment').checked = true;
                document.getElementById('syncBranchDeployments').checked = false;
            } else {
                inputsDiv.style.display = 'none';
            }
        }

        async function addEnvVar() {
            const key = document.getElementById('newEnvKey').value.trim();
            const value = document.getElementById('newEnvValue').value.trim();

            if (!key) {
                showAlert('Please enter a key', 'error');
                return;
            }

            if (!value) {
                showAlert('Please enter a value', 'error');
                return;
            }

            try {
                await apiCall('/api/env', {
                    method: 'POST',
                    body: JSON.stringify({ key, value })
                });

                document.getElementById('newEnvKey').value = '';
                document.getElementById('newEnvValue').value = '';

                showAlert(`Variable '${key}' added successfully`, 'success');
                await loadEnvVars();
            } catch (error) {
                console.error('Error adding env var:', error);
            }
        }

        async function deleteEnvVar(key) {
            if (!confirm(`Delete environment variable '${key}'?`)) {
                return;
            }

            try {
                await apiCall(`/api/env/${key}`, { method: 'DELETE' });
                showAlert(`Variable '${key}' deleted`, 'success');
                await loadEnvVars();
            } catch (error) {
                console.error('Error deleting env var:', error);
            }
        }

        window.editEnvVar = async function(key, currentValue) {
            const newValue = prompt(`Edit value for '${key}':`, currentValue);
            if (newValue === null) return; // User cancelled

            try {
                await apiCall('/api/env', {
                    method: 'POST',
                    body: JSON.stringify({ key, value: newValue })
                });

                showAlert(`Variable '${key}' updated successfully`, 'success');
                await loadEnvVars();
            } catch (error) {
                console.error('Error updating env var:', error);
            }
        }

        async function syncSingleVarToDagsterPlus() {
            const key = document.getElementById('dagsterVarSelect').value;
            const syncFull = document.getElementById('syncFullDeployment').checked;
            const syncBranch = document.getElementById('syncBranchDeployments').checked;
            const fullValue = document.getElementById('fullDeploymentValue').value.trim();
            const branchValue = document.getElementById('branchDeploymentsValue').value.trim();
            const codeLocation = document.getElementById('dagsterCodeLocation').value.trim();

            if (!key) {
                showAlert('Please select a variable', 'error');
                return;
            }

            if (!syncFull && !syncBranch) {
                showAlert('Please select at least one deployment scope', 'error');
                return;
            }

            if (syncFull && !fullValue) {
                showAlert('Please enter a value for Full Deployment', 'error');
                return;
            }

            if (syncBranch && !branchValue) {
                showAlert('Please enter a value for Branch Deployments', 'error');
                return;
            }

            try {
                showAlert('Syncing to Dagster+...', 'info');

                const configs = [];
                if (syncFull) {
                    configs.push({
                        key: key,
                        value: fullValue,
                        scope: 'full',
                        code_location: codeLocation || undefined
                    });
                }
                if (syncBranch) {
                    configs.push({
                        key: key,
                        value: branchValue,
                        scope: 'branch',
                        code_location: codeLocation || undefined
                    });
                }

                const result = await apiCall('/api/env/sync-dagster-plus-with-values', {
                    method: 'POST',
                    body: JSON.stringify({ configs })
                });

                if (result.success) {
                    showAlert(`Successfully synced '${key}' to Dagster+`, 'success');
                    // Clear form
                    document.getElementById('dagsterVarSelect').value = '';
                    document.getElementById('dagsterValueInputs').style.display = 'none';
                } else {
                    const failed = result.results.filter(r => !r.success);
                    showAlert(`Some syncs failed. Check console for details.`, 'error');
                    console.error('Sync failures:', failed);
                }
            } catch (error) {
                console.error('Error syncing to Dagster+:', error);
            }
        }

        // Load sources and destinations with groups
        async function loadSourcesAndDestinations() {
            const sources = await apiCall('/api/sources/consolidated');
            const destinations = await apiCall('/api/destinations/consolidated');

            console.log('Sources loaded:', sources.length);
            console.log('Destinations loaded:', destinations.length);

            const sourceSelect = document.getElementById('sourceType');
            const destSelect = document.getElementById('destinationType');

            console.log('Source select element:', sourceSelect);
            console.log('Destination select element:', destSelect);

            // Create a map for quick lookups
            const sourceMap = {};
            sources.forEach(s => sourceMap[s.name] = s);

            const destMap = {};
            destinations.forEach(d => destMap[d.name] = d);

            // Add grouped sources
            for (const [group, items] of Object.entries(SOURCE_GROUPS)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;

                items.forEach(source => {
                    if (sourceMap[source]) {
                        const option = document.createElement('option');
                        option.value = source;
                        option.textContent = source;
                        optgroup.appendChild(option);
                    }
                });

                if (optgroup.children.length > 0) {
                    sourceSelect.appendChild(optgroup);
                }
            }

            // Add grouped destinations
            console.log('Processing destination groups...');
            for (const [group, items] of Object.entries(DESTINATION_GROUPS)) {
                console.log(`Processing group: ${group}, items:`, items);
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;

                items.forEach(dest => {
                    if (destMap[dest]) {
                        console.log(`Adding destination: ${dest} to group: ${group}`);
                        const option = document.createElement('option');
                        option.value = dest;
                        option.textContent = dest;
                        optgroup.appendChild(option);
                    }
                });

                console.log(`Group ${group} has ${optgroup.children.length} options`);
                if (optgroup.children.length > 0) {
                    destSelect.appendChild(optgroup);
                }
            }
            console.log('Destination select final option count:', destSelect.options.length);
        }

        // Load source configuration fields
        // Helper function to update conditional config fields
        function updateConditionalConfigFields(container) {
            const fields = container.querySelectorAll('[data-show-if-config]');
            fields.forEach(field => {
                const showIf = JSON.parse(field.dataset.showIfConfig);
                let shouldShow = true;

                for (const [dependentKey, expectedValue] of Object.entries(showIf)) {
                    // For boolean fields, check if checkbox is checked
                    const checkbox = container.querySelector(`input[name="config_${dependentKey}"][type="checkbox"]`);
                    if (checkbox) {
                        // For boolean fields, expectedValue is true/false
                        const isChecked = checkbox.checked;
                        if ((expectedValue === true && !isChecked) || (expectedValue === false && isChecked)) {
                            shouldShow = false;
                            break;
                        }
                    } else {
                        // For other fields (select, text, etc.)
                        const dependentField = container.querySelector(`[name="config_${dependentKey}"]`);
                        if (!dependentField || dependentField.value !== expectedValue) {
                            shouldShow = false;
                            break;
                        }
                    }
                }

                field.style.display = shouldShow ? 'block' : 'none';
            });
        }

        async function loadSourceConfiguration(sourceType) {
            const container = document.getElementById('sourceConfigFields');

            if (!sourceType) {
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            try {
                const fields = await apiCall(`/api/source-configuration/${sourceType}`);

                if (fields.length === 0) {
                    container.classList.add('hidden');
                    container.innerHTML = '';
                    return;
                }

                container.classList.remove('hidden');
                container.innerHTML = '<h3 style="margin-bottom: 15px;">Source Configuration</h3>';

                fields.forEach(field => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'form-group';
                    fieldDiv.dataset.fieldKey = field.key;

                    // Handle show_if conditional display
                    if (field.show_if) {
                        fieldDiv.style.display = 'none';
                        fieldDiv.dataset.showIfConfig = JSON.stringify(field.show_if);
                    }

                    if (field.type === 'select') {
                        const label = document.createElement('label');
                        label.htmlFor = field.key;
                        label.textContent = field.label + (field.required ? ' *' : '');
                        fieldDiv.appendChild(label);

                        if (field.help) {
                            const help = document.createElement('p');
                            help.style.fontSize = '13px';
                            help.style.color = '#666';
                            help.style.marginBottom = '8px';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                        const select = document.createElement('select');
                        select.name = `config_${field.key}`;
                        select.id = field.key;
                        select.required = field.required || false;

                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            select.appendChild(option);
                        });

                        if (field.default) {
                            select.value = field.default;
                        }

                        // Add change listener for conditional fields
                        select.addEventListener('change', () => updateConditionalConfigFields(container));
                        fieldDiv.appendChild(select);

                    } else if (field.type === 'multiselect') {
                        const label = document.createElement('label');
                        label.textContent = field.label;
                        fieldDiv.appendChild(label);

                        if (field.help) {
                            const help = document.createElement('p');
                            help.style.fontSize = '13px';
                            help.style.color = '#666';
                            help.style.marginBottom = '10px';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                        field.options.forEach(option => {
                            const checkboxDiv = document.createElement('div');
                            checkboxDiv.className = 'checkbox-group';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = `config_${field.key}`;
                            checkbox.value = option.value;
                            checkbox.id = `${field.key}_${option.value}`;

                            // Check default values
                            if (field.default && field.default.includes(option.value)) {
                                checkbox.checked = true;
                            }

                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.htmlFor = checkbox.id;
                            checkboxLabel.textContent = option.label;

                            checkboxDiv.appendChild(checkbox);
                            checkboxDiv.appendChild(checkboxLabel);
                            fieldDiv.appendChild(checkboxDiv);
                        });

                    } else if (field.type === 'boolean') {
                        const checkboxDiv = document.createElement('div');
                        checkboxDiv.className = 'checkbox-group';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = `config_${field.key}`;
                        checkbox.id = field.key;
                        checkbox.checked = field.default || false;

                        // Add change listener for conditional fields
                        checkbox.addEventListener('change', () => updateConditionalConfigFields(container));

                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = field.key;
                        checkboxLabel.textContent = field.label;

                        checkboxDiv.appendChild(checkbox);
                        checkboxDiv.appendChild(checkboxLabel);
                        fieldDiv.appendChild(checkboxDiv);

                        if (field.help) {
                            const help = document.createElement('p');
                            help.style.fontSize = '13px';
                            help.style.color = '#666';
                            help.style.marginTop = '5px';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                    } else if (field.type === 'textarea') {
                        const label = document.createElement('label');
                        label.htmlFor = field.key;
                        label.textContent = field.label + (field.required ? ' *' : '');
                        fieldDiv.appendChild(label);

                        if (field.help) {
                            const help = document.createElement('p');
                            help.style.fontSize = '13px';
                            help.style.color = '#666';
                            help.style.marginBottom = '8px';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                        const textarea = document.createElement('textarea');
                        textarea.name = `config_${field.key}`;
                        textarea.id = field.key;
                        textarea.placeholder = field.placeholder || '';
                        textarea.required = field.required || false;
                        textarea.rows = 8;
                        textarea.style.fontFamily = 'monospace';
                        textarea.style.fontSize = '13px';
                        fieldDiv.appendChild(textarea);

                    } else {
                        const label = document.createElement('label');
                        label.htmlFor = field.key;
                        label.textContent = field.label + (field.required ? ' *' : '');
                        fieldDiv.appendChild(label);

                        if (field.help) {
                            const help = document.createElement('p');
                            help.style.fontSize = '13px';
                            help.style.color = '#666';
                            help.style.marginBottom = '8px';
                            help.textContent = field.help;
                            fieldDiv.appendChild(help);
                        }

                        const input = document.createElement('input');
                        input.type = field.type === 'password' ? 'password' : 'text';
                        input.name = `config_${field.key}`;
                        input.id = field.key;
                        input.placeholder = field.placeholder || '';
                        input.required = field.required || false;
                        fieldDiv.appendChild(input);
                    }

                    container.appendChild(fieldDiv);
                });

                // Update conditional fields after all fields are rendered
                updateConditionalConfigFields(container);

            } catch (error) {
                container.classList.add('hidden');
                container.innerHTML = '';
            }
        }

        // Show tool recommendation and load credentials
        async function updateToolRecommendation() {
            const sourceType = document.getElementById('sourceType').value;
            const destinationType = document.getElementById('destinationType').value;

            if (!sourceType || !destinationType) {
                document.getElementById('toolRecommendation').classList.add('hidden');
                document.getElementById('credentialsInput').classList.add('hidden');
                return;
            }

            try {
                // Get tool recommendation
                const toolData = await apiCall('/api/tool-recommendation', {
                    method: 'POST',
                    body: JSON.stringify({
                        source_type: sourceType,
                        destination_type: destinationType
                    })
                });

                document.getElementById('recommendedTool').textContent = toolData.tool;
                document.getElementById('toolRecommendation').classList.remove('hidden');

                // Load credential fields
                await loadCredentialInputFields(sourceType, destinationType);
            } catch (error) {
                console.error('Error updating tool recommendation:', error);
            }
        }

        // Helper function to create credential field
        function createCredentialField(cred, prefix = 'cred_') {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'form-group';
            fieldDiv.dataset.fieldKey = cred.key;

            // Handle show_if conditional display
            if (cred.show_if) {
                fieldDiv.style.display = 'none';
                fieldDiv.dataset.showIf = JSON.stringify(cred.show_if);
            }

            const label = document.createElement('label');
            label.textContent = cred.label + (cred.required ? ' *' : '');
            fieldDiv.appendChild(label);

            if (cred.help) {
                const help = document.createElement('p');
                help.style.fontSize = '13px';
                help.style.color = '#666';
                help.style.marginBottom = '8px';
                help.textContent = cred.help;
                fieldDiv.appendChild(help);
            }

            // Create appropriate input element
            let input;
            if (cred.type === 'select') {
                input = document.createElement('select');
                cred.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    input.appendChild(option);
                });
                if (cred.default) {
                    input.value = cred.default;
                }
                // Add change listener for conditional fields
                input.addEventListener('change', () => updateConditionalFields(fieldDiv.parentElement));
            } else if (cred.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 4;
            } else {
                input = document.createElement('input');
                input.type = cred.type === 'password' ? 'password' : 'text';
            }

            input.name = prefix + cred.key;
            input.placeholder = cred.placeholder || '';
            input.required = false; // Make optional since they can use .env
            input.style.fontFamily = cred.type === 'textarea' ? 'monospace' : '';
            fieldDiv.appendChild(input);

            return fieldDiv;
        }

        // Update conditional field visibility
        function updateConditionalFields(container) {
            const fields = container.querySelectorAll('[data-show-if]');
            fields.forEach(field => {
                const showIf = JSON.parse(field.dataset.showIf);
                let shouldShow = true;

                for (const [dependentKey, expectedValue] of Object.entries(showIf)) {
                    // Try with "cred_" prefix first, then without (for test credentials modal)
                    let dependentField = container.querySelector(`[name="cred_${dependentKey}"]`);
                    if (!dependentField) {
                        dependentField = container.querySelector(`[name="${dependentKey}"]`);
                    }

                    if (!dependentField || dependentField.value !== expectedValue) {
                        shouldShow = false;
                        break;
                    }
                }

                field.style.display = shouldShow ? 'block' : 'none';
            });
        }

        // Load credential input fields for source and destination
        async function loadCredentialInputFields(sourceType, destinationType) {
            const credentialsSection = document.getElementById('credentialsInput');
            const sourceFieldsContainer = document.getElementById('sourceCredentialsFields');
            const destFieldsContainer = document.getElementById('destinationCredentialsFields');

            try {
                // Load source credentials
                const sourceCredentials = await apiCall(`/api/credentials/${sourceType}`, { showAlert: false });

                if (sourceCredentials.length > 0) {
                    sourceFieldsContainer.innerHTML = `<h4 style="margin: 20px 0 15px; color: #555;">Source: ${sourceType}</h4>`;
                    sourceCredentials.forEach(cred => {
                        sourceFieldsContainer.appendChild(createCredentialField(cred));
                    });
                    updateConditionalFields(sourceFieldsContainer);
                } else {
                    sourceFieldsContainer.innerHTML = '';
                }

                // Load destination credentials
                const destCredentials = await apiCall(`/api/credentials/${destinationType}`, { showAlert: false });

                if (destCredentials.length > 0) {
                    destFieldsContainer.innerHTML = `<h4 style="margin: 20px 0 15px; color: #555;">Destination: ${destinationType}</h4>`;
                    destCredentials.forEach(cred => {
                        destFieldsContainer.appendChild(createCredentialField(cred));
                    });
                    updateConditionalFields(destFieldsContainer);
                } else {
                    destFieldsContainer.innerHTML = '';
                }

                // Show the credentials section if we have any fields
                if (sourceCredentials.length > 0 || destCredentials.length > 0) {
                    credentialsSection.classList.remove('hidden');
                } else {
                    credentialsSection.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error loading credential fields:', error);
                credentialsSection.classList.add('hidden');
            }
        }

        // Submit pipeline
        // Schedule UI Functions
        function updateScheduleUI() {
            const scheduleType = document.getElementById('scheduleType').value;

            document.getElementById('presetSchedule').style.display = scheduleType === 'preset' ? 'block' : 'none';
            document.getElementById('customSchedule').style.display = scheduleType === 'custom' ? 'block' : 'none';
            document.getElementById('cronSchedule').style.display = scheduleType === 'cron' ? 'block' : 'none';
            document.getElementById('manualSchedule').style.display = scheduleType === 'manual' ? 'block' : 'none';

            // Update cron value based on selection
            if (scheduleType === 'preset') {
                updateCronFromPreset();
            } else if (scheduleType === 'custom') {
                updateCronFromCustom();
            } else if (scheduleType === 'cron') {
                const cronValue = document.getElementById('cronExpression').value;
                document.getElementById('finalCronSchedule').value = cronValue;
                updateCronDisplay(cronValue);
            } else if (scheduleType === 'manual') {
                document.getElementById('finalCronSchedule').value = '';
                document.getElementById('generatedCronDisplay').style.display = 'none';
            }
        }

        function updateCronFromPreset() {
            const preset = document.getElementById('schedulePreset').value;
            document.getElementById('finalCronSchedule').value = preset;
            updateCronDisplay(preset);
        }

        function updateCustomScheduleFields() {
            const frequency = document.getElementById('customFrequency').value;

            document.getElementById('customIntervalDiv').style.display = frequency === 'hourly' ? 'block' : 'none';
            document.getElementById('customTimeDiv').style.display = ['daily', 'weekly', 'monthly'].includes(frequency) ? 'block' : 'none';
            document.getElementById('customDayDiv').style.display = frequency === 'weekly' ? 'block' : 'none';
            document.getElementById('customDateDiv').style.display = frequency === 'monthly' ? 'block' : 'none';
        }

        function updateCronFromCustom() {
            const frequency = document.getElementById('customFrequency').value;
            let cron = '';

            if (frequency === 'hourly') {
                const interval = document.getElementById('customInterval').value;
                cron = `0 */${interval} * * *`;
            } else if (frequency === 'daily') {
                const time = document.getElementById('customTime').value.split(':');
                cron = `${time[1]} ${time[0]} * * *`;
            } else if (frequency === 'weekly') {
                const time = document.getElementById('customTime').value.split(':');
                const day = document.getElementById('customDay').value;
                cron = `${time[1]} ${time[0]} * * ${day}`;
            } else if (frequency === 'monthly') {
                const time = document.getElementById('customTime').value.split(':');
                const date = document.getElementById('customDate').value;
                cron = `${time[1]} ${time[0]} ${date} * *`;
            }

            document.getElementById('finalCronSchedule').value = cron;
            updateCronDisplay(cron);
        }

        function updateCronDisplay(cron) {
            const display = document.getElementById('generatedCronDisplay');
            const value = document.getElementById('generatedCronValue');

            if (cron) {
                value.textContent = cron;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }

        // Update cron when typing in advanced field
        document.addEventListener('DOMContentLoaded', function() {
            const cronInput = document.getElementById('cronExpression');
            if (cronInput) {
                cronInput.addEventListener('input', function() {
                    const cronValue = this.value;
                    document.getElementById('finalCronSchedule').value = cronValue;
                    updateCronDisplay(cronValue);
                });
            }
        });

        // Write Disposition UI
        window.updateWriteDispositionUI = function() {
            const writeDisposition = document.getElementById('writeDisposition').value;
            const mergeConfig = document.getElementById('mergeConfiguration');

            if (writeDisposition === 'merge') {
                mergeConfig.style.display = 'block';
            } else {
                mergeConfig.style.display = 'none';
            }
        }

        // Incremental Loading UI
        window.updateIncrementalUI = function() {
            const incrementalEnabled = document.getElementById('incrementalEnabled').checked;
            const incrementalConfig = document.getElementById('incrementalConfiguration');

            if (incrementalEnabled) {
                incrementalConfig.style.display = 'block';
            } else {
                incrementalConfig.style.display = 'none';
            }
        }

        // Stepper Navigation
        let currentStep = 1;

        window.nextStep = function() {
            if (currentStep < 4) {
                currentStep++;
                updateStepUI();
            }
        }

        window.prevStep = function() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        window.updateStepUI = function() {
            // Update stepper circles
            document.querySelectorAll('.stepper .step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < currentStep) step.classList.add('completed');
                if (stepNum === currentStep) step.classList.add('active');
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.toggle('active', index + 1 === currentStep);
            });

            // Update buttons
            document.getElementById('prevBtn').style.display = currentStep === 1 ? 'none' : 'inline-flex';
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.textContent = currentStep === 4 ? 'Create Pipeline' : 'Next';
        }

        window.nextStepOrSubmit = function() {
            if (currentStep === 4) {
                submitPipeline();
            } else {
                // Basic validation for current step
                const stepContent = document.querySelector(`.step-content[data-step="${currentStep}"]`);
                const requiredFields = stepContent.querySelectorAll('[required]');
                let isValid = true;

                for (const field of requiredFields) {
                    if (!field.value || field.value.trim() === '') {
                        field.reportValidity();
                        isValid = false;
                        break;
                    }
                }

                if (isValid) {
                    nextStep();
                }
            }
        }

        window.resetStepper = function() {
            currentStep = 1;
            updateStepUI();
            // Clear tags and kinds
            window.pipelineTags = {};
            window.pipelineKinds = [];
            renderTags();
            renderKinds();
        }

        // Tags management
        window.pipelineTags = {};

        window.addTag = function() {
            const key = document.getElementById('newTagKey').value.trim();
            const value = document.getElementById('newTagValue').value.trim();

            if (!key || !value) {
                showAlert('Please enter both key and value', 'error');
                return;
            }

            window.pipelineTags[key] = value;
            document.getElementById('newTagKey').value = '';
            document.getElementById('newTagValue').value = '';
            renderTags();
        }

        window.removeTag = function(key) {
            delete window.pipelineTags[key];
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tagsList');
            const tags = Object.entries(window.pipelineTags);

            if (tags.length === 0) {
                container.innerHTML = '<span style="color: #9e9e9e; font-size: 0.875rem;">No tags added yet</span>';
                return;
            }

            container.innerHTML = tags.map(([key, value]) => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <code style="background: #e3f2fd; padding: 2px 8px; border-radius: 3px; font-size: 0.8rem; color: #1976d2;">${key}</code>
                    <span style="color: #757575;">:</span>
                    <span style="flex: 1; color: #212121; font-size: 0.875rem;">${value}</span>
                    <button type="button" onclick="removeTag('${key}')" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 4px 8px; font-size: 1.2em;" title="Remove tag">√ó</button>
                </div>
            `).join('');
        }

        // Kinds management
        window.pipelineKinds = [];

        window.addKind = function() {
            const input = document.getElementById('newKindInput');
            const kind = input.value.trim().toLowerCase();

            if (!kind) {
                showAlert('Please enter a kind', 'error');
                return;
            }

            if (window.pipelineKinds.includes(kind)) {
                showAlert('Kind already added', 'error');
                return;
            }

            window.pipelineKinds.push(kind);
            input.value = '';
            renderKinds();
        }

        window.removeKind = function(kind) {
            window.pipelineKinds = window.pipelineKinds.filter(k => k !== kind);
            renderKinds();
        }

        function renderKinds() {
            const container = document.getElementById('kindsList');

            if (window.pipelineKinds.length === 0) {
                container.innerHTML = '<span style="color: #9e9e9e; font-size: 0.875rem;">No kinds added yet. Will auto-populate based on tool and connectors.</span>';
                return;
            }

            container.innerHTML = window.pipelineKinds.map(kind => `
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border: 1px solid #e0e0e0; border-radius: 16px;">
                    <span style="font-size: 0.875rem; color: #212121;">${kind}</span>
                    <button type="button" onclick="removeKind('${kind}')" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 0; font-size: 1.1em; line-height: 1;" title="Remove kind">√ó</button>
                </div>
            `).join('');
        }

        // Auto-populate kinds when source/destination change
        function autoPopulateKinds() {
            const sourceType = document.getElementById('sourceType').value;
            const destType = document.getElementById('destinationType').value;

            if (!sourceType || !destType) return;

            // Clear and repopulate with tool + source + destination
            const tool = chooseTool(sourceType, destType); // will determine from recommendation
            window.pipelineKinds = [];

            // Add tool (dlt or sling)
            if (tool) window.pipelineKinds.push(tool);

            // Add source
            if (sourceType) window.pipelineKinds.push(sourceType.toLowerCase());

            // Add destination
            if (destType) window.pipelineKinds.push(destType.toLowerCase());

            renderKinds();
        }

        // Helper to determine tool (simplified version)
        function chooseTool(source, dest) {
            // Get the recommended tool from the UI (populated by updateToolRecommendation)
            const recommendedToolEl = document.getElementById('recommendedTool');
            if (recommendedToolEl && recommendedToolEl.textContent) {
                return recommendedToolEl.textContent.toLowerCase();
            }
            // Default to dlt if no recommendation available yet
            return 'dlt';
        }

        async function submitPipeline() {
            const form = document.getElementById('createPipelineForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const cronValue = document.getElementById('finalCronSchedule').value;

            // Parse owners from comma-separated string to array
            const ownersInput = formData.get('owners');
            const owners = ownersInput ? ownersInput.split(',').map(o => o.trim()).filter(o => o) : [];

            // Get tags from global state
            const tags = Object.keys(window.pipelineTags).length > 0 ? {...window.pipelineTags} : undefined;

            // Get kinds from global state
            const kinds = window.pipelineKinds.length > 0 ? [...window.pipelineKinds] : undefined;

            // Get retry policy settings
            const retryBackoff = formData.get('retry_backoff');
            const retryJitter = formData.get('retry_jitter');

            // Get incremental loading settings
            const incrementalEnabled = document.getElementById('incrementalEnabled').checked;
            const cursorField = incrementalEnabled ? formData.get('cursorField') : null;
            const cursorInitialValue = incrementalEnabled ? formData.get('cursorInitialValue') : null;
            const partitionFrequency = incrementalEnabled ? (formData.get('partitionFrequency') || '@daily') : null;

            const data = {
                name: formData.get('name'),
                source_type: formData.get('source_type'),
                destination_type: formData.get('destination_type'),
                description: formData.get('description') || `Load ${formData.get('source_type')} data to ${formData.get('destination_type')}`,
                group_name: formData.get('group_name') || 'default',
                schedule_enabled: !!cronValue,
                cron_schedule: cronValue || null,
                source_configuration: {},
                owners: owners.length > 0 ? owners : undefined,
                tags: tags,
                kinds: kinds,
                retries: parseInt(formData.get('retries')) || 2,
                retry_delay: parseInt(formData.get('retry_delay')) || 30,
                retry_backoff: retryBackoff || 'LINEAR',
                retry_jitter: retryJitter || null,
                write_disposition: formData.get('writeDisposition') || 'append',
                primary_key: formData.get('primaryKey') || null,
                merge_key: formData.get('mergeKey') || null,
                incremental_enabled: incrementalEnabled,
                cursor_field: cursorField,
                cursor_initial_value: cursorInitialValue,
                partition_frequency: partitionFrequency,
                file_format: formData.get('fileFormat') || 'parquet',
                compression: formData.get('compression') || 'gzip',
                table_prefix: formData.get('tablePrefix') || null,
                table_suffix: formData.get('tableSuffix') || null,
                schema_override: formData.get('schemaOverride') || null,
                enable_staging: document.getElementById('enableStaging')?.checked || false,
                column_hints: formData.get('columnHints') || null
            };

            // Collect source configuration
            const configFields = document.querySelectorAll('[name^="config_"]');
            configFields.forEach(field => {
                const key = field.name.replace('config_', '');

                if (field.type === 'checkbox') {
                    const multiCheckboxes = document.querySelectorAll(`[name="${field.name}"]:checked`);
                    if (multiCheckboxes.length > 0) {
                        if (multiCheckboxes.length === 1 && multiCheckboxes[0].value === 'on') {
                            data.source_configuration[key] = true;
                        } else {
                            data.source_configuration[key] = Array.from(multiCheckboxes).map(cb => cb.value);
                        }
                    }
                } else if (field.value) {
                    data.source_configuration[key] = field.value;
                }
            });

            try {
                let result;
                if (editingPipeline) {
                    // Update existing pipeline
                    result = await apiCall(`/api/pipelines/${editingPipeline.tool}/${editingPipeline.name}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new pipeline
                    result = await apiCall('/api/pipelines', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }

                showAlert(result.message, 'success');
                closeModal('createPipelineModal');
                form.reset();
                document.querySelector('input[name="name"]').disabled = false;
                document.getElementById('sourceConfigFields').classList.add('hidden');
                document.getElementById('toolRecommendation').classList.add('hidden');
                document.getElementById('credentialsInput').innerHTML = '';
                document.getElementById('sourceCredentialsFields').innerHTML = '';
                document.getElementById('destinationCredentialsFields').innerHTML = '';
                editingPipeline = null;
                resetStepper();

                await loadPipelines();
                await loadGitStatus();

            } catch (error) {
                console.error('Error saving pipeline:', error);
            }
        }

        // Global state for pipelines
        let allPipelinesData = [];
        let pipelineSearchTerm = '';
        let pipelineSortColumn = 'name';
        let pipelineSortDirection = 'asc';
        let currentPage = 1;
        let rowsPerPage = 25;

        // Column visibility (load from localStorage)
        let visibleColumns = JSON.parse(localStorage.getItem('pipelineColumns') || '{"type": true, "source": true, "destination": true, "description": true, "status": true}');

        // Advanced filters
        let advancedFilters = {
            tool: 'all',
            enabled: 'all'
        };
        let showFilters = false;

        // Load pipelines
        async function loadPipelines() {
            const container = document.getElementById('pipelinesContainer');
            try {
                const pipelines = await apiCall('/api/pipelines', { showAlert: false });

                allPipelinesData = [
                    ...pipelines.dlt.map(p => ({...p, tool: 'dlt'})),
                    ...pipelines.sling.map(p => ({...p, tool: 'sling'}))
                ];

                if (allPipelinesData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>No pipelines yet. Create your first one!</p>
                            <button onclick="openCreatePipelineModal()" class="btn-success" style="margin-top: 15px;">Create Pipeline</button>
                        </div>
                    `;
                    return;
                }

                renderPipelinesTable();

            } catch (error) {
                console.error('Error loading pipelines:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p style="color: #e74c3c;">Error loading pipelines</p>
                        <p style="font-size: 14px; margin-top: 10px;">${error.message}</p>
                        <button onclick="loadPipelines()" class="btn-outline btn-small" style="margin-top: 15px;">Retry</button>
                    </div>
                `;
            }
        }

        function renderPipelinesTable() {
            const container = document.getElementById('pipelinesContainer');

            // Store current focus state before re-rendering
            const activeElement = document.activeElement;
            const isSearchFocused = activeElement && activeElement.id === 'pipelineSearchInput';
            const cursorPosition = isSearchFocused ? activeElement.selectionStart : null;

            // Filter pipelines by search term and advanced filters
            let filteredPipelines = allPipelinesData.filter(p => {
                // Search term filter
                if (pipelineSearchTerm) {
                    const term = pipelineSearchTerm.toLowerCase();
                    const matchesSearch = p.name.toLowerCase().includes(term) ||
                           p.source.toLowerCase().includes(term) ||
                           p.destination.toLowerCase().includes(term) ||
                           (p.description && p.description.toLowerCase().includes(term)) ||
                           p.tool.toLowerCase().includes(term);
                    if (!matchesSearch) return false;
                }

                // Tool filter
                if (advancedFilters.tool !== 'all' && p.tool !== advancedFilters.tool) {
                    return false;
                }

                // Status filter
                if (advancedFilters.enabled === 'enabled' && !p.enabled) {
                    return false;
                }
                if (advancedFilters.enabled === 'disabled' && p.enabled) {
                    return false;
                }

                return true;
            });

            // Sort pipelines
            filteredPipelines.sort((a, b) => {
                let aVal = a[pipelineSortColumn];
                let bVal = b[pipelineSortColumn];

                // Handle boolean for enabled status
                if (pipelineSortColumn === 'enabled') {
                    aVal = a.enabled ? 1 : 0;
                    bVal = b.enabled ? 1 : 0;
                }

                // Convert to string for comparison
                aVal = String(aVal || '').toLowerCase();
                bVal = String(bVal || '').toLowerCase();

                if (aVal < bVal) return pipelineSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return pipelineSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination calculations
            const totalItems = filteredPipelines.length;
            const totalPages = Math.ceil(totalItems / rowsPerPage);

            // Ensure current page is valid
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalItems);
            const paginatedPipelines = filteredPipelines.slice(startIndex, endIndex);

            const selectedCount = document.querySelectorAll('.pipeline-checkbox:checked').length;

            container.innerHTML = `
                <!-- Search and Bulk Actions Bar -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                    <input type="text"
                           id="pipelineSearchInput"
                           placeholder="üîç Search pipelines..."
                           value="${pipelineSearchTerm}"
                           oninput="handlePipelineSearch(this.value)"
                           style="flex: 1; min-width: 250px; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.875rem;">

                    <button onclick="toggleFilters()" class="btn-outline btn-small" title="Advanced filters">
                        <span style="margin-right: 4px;">‚ñΩ</span> Filters
                    </button>

                    <button onclick="toggleColumnPicker()" class="btn-outline btn-small" title="Show/hide columns">
                        <span style="margin-right: 4px;">‚ãÆ</span> Columns
                    </button>

                    <div id="bulkActionsBar" style="display: ${selectedCount > 0 ? 'flex' : 'none'}; gap: 8px; align-items: center;">
                        <span style="color: #64748b; font-size: 0.875rem; white-space: nowrap;">${selectedCount} selected</span>
                        <button onclick="bulkEnablePipelines()" class="btn-success btn-small" style="white-space: nowrap;">Enable All</button>
                        <button onclick="bulkDisablePipelines()" class="btn-outline btn-small" style="white-space: nowrap;">Disable All</button>
                        <button onclick="bulkDeletePipelines()" class="btn-danger btn-small" style="white-space: nowrap;">Delete Selected</button>
                    </div>
                </div>

                <!-- Advanced Filters Panel -->
                ${showFilters ? `
                    <div style="background: white; padding: 12px 16px; margin-bottom: 12px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap;">
                            <div style="flex: 0 0 auto; min-width: 160px;">
                                <label style="font-size: 0.75rem; font-weight: 500; color: #616161; margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px;">Tool Type</label>
                                <select onchange="updateFilter('tool', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 0.875rem; background: white; cursor: pointer;">
                                    <option value="all" ${advancedFilters.tool === 'all' ? 'selected' : ''}>All Tools</option>
                                    <option value="dlt" ${advancedFilters.tool === 'dlt' ? 'selected' : ''}>DLT Only</option>
                                    <option value="sling" ${advancedFilters.tool === 'sling' ? 'selected' : ''}>Sling Only</option>
                                </select>
                            </div>
                            <div style="flex: 0 0 auto; min-width: 160px;">
                                <label style="font-size: 0.75rem; font-weight: 500; color: #616161; margin-bottom: 4px; display: block; text-transform: uppercase; letter-spacing: 0.5px;">Status</label>
                                <select onchange="updateFilter('enabled', this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 0.875rem; background: white; cursor: pointer;">
                                    <option value="all" ${advancedFilters.enabled === 'all' ? 'selected' : ''}>All Statuses</option>
                                    <option value="enabled" ${advancedFilters.enabled === 'enabled' ? 'selected' : ''}>Enabled Only</option>
                                    <option value="disabled" ${advancedFilters.enabled === 'disabled' ? 'selected' : ''}>Disabled Only</option>
                                </select>
                            </div>
                            <div style="flex: 0 0 auto;">
                                <button onclick="clearFilters()" class="btn-outline btn-small">Clear Filters</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Column Picker (dropdown style) -->
                <div id="columnPicker" style="display: none; position: absolute; right: 24px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 200px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 0.875rem; font-weight: 600; color: #212121;">Show Columns</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" ${visibleColumns.type ? 'checked' : ''} onchange="toggleColumn('type', this.checked)"> Type
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" ${visibleColumns.source ? 'checked' : ''} onchange="toggleColumn('source', this.checked)"> Source
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" ${visibleColumns.destination ? 'checked' : ''} onchange="toggleColumn('destination', this.checked)"> Destination
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" ${visibleColumns.description ? 'checked' : ''} onchange="toggleColumn('description', this.checked)"> Description
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" ${visibleColumns.status ? 'checked' : ''} onchange="toggleColumn('status', this.checked)"> Status
                        </label>
                    </div>
                </div>

                <!-- Pipelines Table -->
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" title="Select all">
                            </th>
                            <th style="cursor: pointer;" onclick="sortPipelines('name')">
                                Name ${pipelineSortColumn === 'name' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ${visibleColumns.type ? `
                            <th style="cursor: pointer;" onclick="sortPipelines('tool')">
                                Type ${pipelineSortColumn === 'tool' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ` : ''}
                            ${visibleColumns.source ? `
                            <th style="cursor: pointer;" onclick="sortPipelines('source')">
                                Source ${pipelineSortColumn === 'source' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ` : ''}
                            ${visibleColumns.destination ? `
                            <th style="cursor: pointer;" onclick="sortPipelines('destination')">
                                Destination ${pipelineSortColumn === 'destination' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ` : ''}
                            ${visibleColumns.description ? `
                            <th style="cursor: pointer;" onclick="sortPipelines('description')">
                                Description ${pipelineSortColumn === 'description' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ` : ''}
                            ${visibleColumns.status ? `
                            <th style="cursor: pointer;" onclick="sortPipelines('enabled')">
                                Status ${pipelineSortColumn === 'enabled' ? (pipelineSortDirection === 'asc' ? '‚Üë' : '‚Üì') : ''}
                            </th>
                            ` : ''}
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedPipelines.map(p => `
                            <tr>
                                <td>
                                    <input type="checkbox" class="pipeline-checkbox" value="${p.tool}:${p.name}" onchange="updateBulkActionsBar()">
                                </td>
                                <td>
                                    <span class="pipeline-name">${p.name}</span>
                                </td>
                                ${visibleColumns.type ? `
                                <td>
                                    <span class="badge badge-${p.tool}">${p.tool.toUpperCase()}</span>
                                </td>
                                ` : ''}
                                ${visibleColumns.source ? `
                                <td style="color: #616161;">${p.source}</td>
                                ` : ''}
                                ${visibleColumns.destination ? `
                                <td style="color: #616161;">${p.destination}</td>
                                ` : ''}
                                ${visibleColumns.description ? `
                                <td style="color: #757575; font-size: 0.8125rem;">${p.description || '‚Äî'}</td>
                                ` : ''}
                                ${visibleColumns.status ? `
                                <td>
                                    <label class="toggle-switch" title="${p.enabled ? 'Enabled' : 'Disabled'}">
                                        <input type="checkbox"
                                               ${p.enabled ? 'checked' : ''}
                                               onchange="togglePipelineEnabled('${p.tool}', '${p.name}', this.checked)"
                                               data-tool="${p.tool}"
                                               data-name="${p.name}">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                                ` : ''}
                                <td style="text-align: right;">
                                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                                        <button class="btn-small" onclick="editPipeline('${p.tool}', '${p.name}')" style="text-transform: none;" title="Edit pipeline">
                                            <span class="action-icon">‚úé</span><span class="action-text">Edit</span>
                                        </button>
                                        <button class="btn-small" onclick="editMetadata('${p.tool}', '${p.name}')" style="text-transform: none; background: #8b5cf6; color: white;" title="Edit metadata">
                                            <span class="action-icon">‚ãÆ</span><span class="action-text">Metadata</span>
                                        </button>
                                        <button class="btn-danger btn-small" onclick="deletePipeline('${p.tool}', '${p.name}')" style="text-transform: none;" title="Delete pipeline">
                                            <span class="action-icon">√ó</span><span class="action-text">Delete</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                ${filteredPipelines.length === 0 && pipelineSearchTerm ? `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>No pipelines match "${pipelineSearchTerm}"</p>
                        <button onclick="clearPipelineSearch()" class="btn-outline btn-small" style="margin-top: 12px;">Clear Search</button>
                    </div>
                ` : ''}

                ${filteredPipelines.length > 0 ? `
                    <!-- Pagination Controls (MUI Style) -->
                    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-top: 16px; padding: 12px 0; flex-wrap: nowrap;">
                        <!-- Rows per page -->
                        <div style="display: flex; align-items: center; gap: 8px; white-space: nowrap;">
                            <span style="font-size: 0.875rem; color: #616161;">Rows per page:</span>
                            <select onchange="changeRowsPerPage(this.value)" style="min-height: 32px; width: 70px; padding: 4px 8px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 0.875rem; background: rgba(0, 0, 0, 0.02); cursor: pointer; color: #212121;">
                                <option value="10" ${rowsPerPage === 10 ? 'selected' : ''}>10</option>
                                <option value="25" ${rowsPerPage === 25 ? 'selected' : ''}>25</option>
                                <option value="50" ${rowsPerPage === 50 ? 'selected' : ''}>50</option>
                                <option value="100" ${rowsPerPage === 100 ? 'selected' : ''}>100</option>
                            </select>
                        </div>

                        <!-- Page info -->
                        <div style="font-size: 0.875rem; color: #616161; white-space: nowrap;">
                            ${startIndex + 1}‚Äì${endIndex} of ${totalItems}
                        </div>

                        <!-- Page navigation -->
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} title="First page" style="width: 32px; height: 32px; padding: 0; border: 1px solid ${currentPage === 1 ? '#e0e0e0' : '#1976d2'}; border-radius: 8px; background: ${currentPage === 1 ? 'transparent' : 'rgba(25, 118, 210, 0.04)'}; color: ${currentPage === 1 ? '#bdbdbd' : '#1976d2'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.08)'" onmouseout="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.04)'">‚Äπ‚Äπ</button>
                            <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} title="Previous page" style="width: 32px; height: 32px; padding: 0; border: 1px solid ${currentPage === 1 ? '#e0e0e0' : '#1976d2'}; border-radius: 8px; background: ${currentPage === 1 ? 'transparent' : 'rgba(25, 118, 210, 0.04)'}; color: ${currentPage === 1 ? '#bdbdbd' : '#1976d2'}; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.08)'" onmouseout="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.04)'">‚Äπ</button>
                            <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} title="Next page" style="width: 32px; height: 32px; padding: 0; border: 1px solid ${currentPage === totalPages ? '#e0e0e0' : '#1976d2'}; border-radius: 8px; background: ${currentPage === totalPages ? 'transparent' : 'rgba(25, 118, 210, 0.04)'}; color: ${currentPage === totalPages ? '#bdbdbd' : '#1976d2'}; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.08)'" onmouseout="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.04)'">‚Ä∫</button>
                            <button onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} title="Last page" style="width: 32px; height: 32px; padding: 0; border: 1px solid ${currentPage === totalPages ? '#e0e0e0' : '#1976d2'}; border-radius: 8px; background: ${currentPage === totalPages ? 'transparent' : 'rgba(25, 118, 210, 0.04)'}; color: ${currentPage === totalPages ? '#bdbdbd' : '#1976d2'}; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.08)'" onmouseout="if(!this.disabled) this.style.background='rgba(25, 118, 210, 0.04)'">‚Ä∫‚Ä∫</button>
                        </div>
                    </div>
                ` : ''}
            `;

            // Restore focus to search input if it was focused before
            if (isSearchFocused) {
                const searchInput = document.getElementById('pipelineSearchInput');
                if (searchInput) {
                    searchInput.focus();
                    if (cursorPosition !== null) {
                        searchInput.setSelectionRange(cursorPosition, cursorPosition);
                    }
                }
            }
        }

        window.handlePipelineSearch = function(term) {
            pipelineSearchTerm = term;
            renderPipelinesTable();
        }

        window.clearPipelineSearch = function() {
            pipelineSearchTerm = '';
            document.getElementById('pipelineSearchInput').value = '';
            renderPipelinesTable();
        }

        window.goToPage = function(page) {
            currentPage = page;
            renderPipelinesTable();
            // Scroll to top of table
            document.getElementById('pipelinesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        window.changeRowsPerPage = function(value) {
            rowsPerPage = parseInt(value);
            currentPage = 1; // Reset to first page
            renderPipelinesTable();
        }

        window.toggleFilters = function() {
            showFilters = !showFilters;
            renderPipelinesTable();
        }

        window.toggleColumnPicker = function() {
            const picker = document.getElementById('columnPicker');
            if (picker) {
                picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
            }
        }

        window.toggleColumn = function(column, visible) {
            visibleColumns[column] = visible;
            localStorage.setItem('pipelineColumns', JSON.stringify(visibleColumns));
            // Save picker state before re-render
            const picker = document.getElementById('columnPicker');
            const wasOpen = picker && picker.style.display !== 'none';
            renderPipelinesTable();
            // Restore picker state after re-render
            if (wasOpen) {
                setTimeout(() => {
                    const newPicker = document.getElementById('columnPicker');
                    if (newPicker) newPicker.style.display = 'block';
                }, 0);
            }
        }

        window.updateFilter = function(filterType, value) {
            advancedFilters[filterType] = value;
            currentPage = 1; // Reset to first page when filtering
            renderPipelinesTable();
        }

        window.clearFilters = function() {
            advancedFilters = {
                tool: 'all',
                enabled: 'all'
            };
            currentPage = 1;
            renderPipelinesTable();
        }

        // Close column picker when clicking outside
        document.addEventListener('click', function(event) {
            const picker = document.getElementById('columnPicker');
            const columnBtn = event.target.closest('button[onclick="toggleColumnPicker()"]');
            if (picker && picker.style.display !== 'none' && !picker.contains(event.target) && !columnBtn) {
                picker.style.display = 'none';
            }
        });

        window.sortPipelines = function(column) {
            if (pipelineSortColumn === column) {
                pipelineSortDirection = pipelineSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                pipelineSortColumn = column;
                pipelineSortDirection = 'asc';
            }
            renderPipelinesTable();
        }

        window.toggleSelectAll = function(checked) {
            document.querySelectorAll('.pipeline-checkbox').forEach(cb => {
                cb.checked = checked;
            });
            updateBulkActionsBar();
        }

        window.updateBulkActionsBar = function() {
            const selectedCount = document.querySelectorAll('.pipeline-checkbox:checked').length;
            const bulkBar = document.getElementById('bulkActionsBar');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            if (bulkBar) {
                bulkBar.style.display = selectedCount > 0 ? 'flex' : 'none';
                bulkBar.querySelector('span').textContent = `${selectedCount} selected`;
            }

            // Update select all checkbox state
            const totalCheckboxes = document.querySelectorAll('.pipeline-checkbox').length;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = selectedCount === totalCheckboxes && totalCheckboxes > 0;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < totalCheckboxes;
            }
        }

        window.bulkEnablePipelines = async function() {
            const selected = getSelectedPipelines();
            if (selected.length === 0) return;

            if (!confirm(`Enable ${selected.length} pipeline(s)?`)) return;

            for (const {tool, name} of selected) {
                try {
                    await apiCall(`/api/pipelines/${tool}/${name}/toggle`, {
                        method: 'PATCH',
                        body: JSON.stringify({enabled: true})
                    });
                } catch (error) {
                    console.error(`Error enabling ${name}:`, error);
                }
            }

            showAlert(`Enabled ${selected.length} pipeline(s)`, 'success');
            await loadPipelines();
            await loadGitStatus();
        }

        window.bulkDisablePipelines = async function() {
            const selected = getSelectedPipelines();
            if (selected.length === 0) return;

            if (!confirm(`Disable ${selected.length} pipeline(s)?`)) return;

            for (const {tool, name} of selected) {
                try {
                    await apiCall(`/api/pipelines/${tool}/${name}/toggle`, {
                        method: 'PATCH',
                        body: JSON.stringify({enabled: false})
                    });
                } catch (error) {
                    console.error(`Error disabling ${name}:`, error);
                }
            }

            showAlert(`Disabled ${selected.length} pipeline(s)`, 'success');
            await loadPipelines();
            await loadGitStatus();
        }

        window.bulkDeletePipelines = async function() {
            const selected = getSelectedPipelines();
            if (selected.length === 0) return;

            if (!confirm(`‚ö†Ô∏è Delete ${selected.length} pipeline(s)? This cannot be undone!`)) return;

            let successCount = 0;
            for (const {tool, name} of selected) {
                try {
                    await apiCall(`/api/pipelines/${tool}/${name}`, {method: 'DELETE'});
                    successCount++;
                } catch (error) {
                    console.error(`Error deleting ${name}:`, error);
                }
            }

            showAlert(`Deleted ${successCount} pipeline(s)`, 'success');
            await loadPipelines();
            await loadGitStatus();
        }

        function getSelectedPipelines() {
            const selected = [];
            document.querySelectorAll('.pipeline-checkbox:checked').forEach(cb => {
                const [tool, name] = cb.value.split(':');
                selected.push({tool, name});
            });
            return selected;
        }

        // Toggle pipeline enabled/disabled
        async function togglePipelineEnabled(tool, name, enabled) {
            try {
                await apiCall(`/api/pipelines/${tool}/${name}/toggle`, {
                    method: 'PATCH',
                    body: JSON.stringify({enabled})
                });
                showAlert(`Pipeline "${name}" ${enabled ? 'enabled' : 'disabled'}`, 'success');
                await loadGitStatus();
            } catch (error) {
                console.error('Error toggling pipeline:', error);
                // Revert the toggle on error
                const checkbox = document.querySelector(`input[data-tool="${tool}"][data-name="${name}"]`);
                if (checkbox) {
                    checkbox.checked = !enabled;
                }
            }
        }

        // Delete pipeline
        async function deletePipeline(tool, name) {
            if (!confirm(`Are you sure you want to delete the ${tool} pipeline "${name}"?`)) {
                return;
            }

            try {
                await apiCall(`/api/pipelines/${tool}/${name}`, {method: 'DELETE'});
                showAlert(`Pipeline "${name}" deleted successfully`, 'success');
                await loadPipelines();
                await loadGitStatus();
            } catch (error) {
                console.error('Error deleting pipeline:', error);
            }
        }

        // Metadata editing
        window.metadataTags = {};
        window.metadataKinds = [];

        async function editMetadata(tool, name) {
            try {
                // Get pipeline metadata
                const metadata = await apiCall(`/api/pipelines/${tool}/${name}/metadata`, { showAlert: false });

                // Store pipeline info
                document.getElementById('metadataTool').value = tool;
                document.getElementById('metadataPipelineName').value = name;
                document.getElementById('metadataModalTitle').textContent = `Edit Metadata: ${name}`;

                // Populate form fields
                document.getElementById('metadataEnabled').checked = metadata.enabled !== false;
                document.getElementById('metadataDescription').value = metadata.description || '';
                document.getElementById('metadataGroupName').value = metadata.group_name || 'default';
                document.getElementById('metadataOwners').value = metadata.owners ? metadata.owners.join(', ') : '';

                // Populate tags
                window.metadataTags = metadata.tags || {};
                renderMetadataTags();

                // Populate kinds
                window.metadataKinds = metadata.kinds || [];
                renderMetadataKinds();

                // Populate retry policy
                document.getElementById('metadataRetries').value = metadata.retries || 2;
                document.getElementById('metadataRetryDelay').value = metadata.retry_delay || 30;
                document.getElementById('metadataRetryBackoff').value = metadata.retry_backoff || 'LINEAR';
                document.getElementById('metadataRetryJitter').value = metadata.retry_jitter || '';

                openModal('editMetadataModal');
            } catch (error) {
                console.error('Error loading metadata:', error);
                showAlert('Error loading metadata', 'error');
            }
        }

        function renderMetadataTags() {
            const container = document.getElementById('metadataTagsList');
            container.innerHTML = '';

            for (const [key, value] of Object.entries(window.metadataTags)) {
                const tagDiv = document.createElement('div');
                tagDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 13px;';
                tagDiv.innerHTML = `
                    <span><strong>${key}:</strong> ${value}</span>
                    <button onclick="removeMetadataTag('${key}')" style="background: none; border: none; color: #666; cursor: pointer; padding: 0 4px; font-size: 16px;">&times;</button>
                `;
                container.appendChild(tagDiv);
            }
        }

        function renderMetadataKinds() {
            const container = document.getElementById('metadataKindsList');
            container.innerHTML = '';

            window.metadataKinds.forEach(kind => {
                const kindDiv = document.createElement('div');
                kindDiv.style.cssText = 'display: inline-flex; align-items: center; gap: 4px; background: #f3e5f5; padding: 4px 8px; border-radius: 4px; font-size: 13px;';
                kindDiv.innerHTML = `
                    <span>${kind}</span>
                    <button onclick="removeMetadataKind('${kind}')" style="background: none; border: none; color: #666; cursor: pointer; padding: 0 4px; font-size: 16px;">&times;</button>
                `;
                container.appendChild(kindDiv);
            });
        }

        window.addMetadataTag = function() {
            const key = document.getElementById('metadataNewTagKey').value.trim();
            const value = document.getElementById('metadataNewTagValue').value.trim();

            if (key && value) {
                window.metadataTags[key] = value;
                renderMetadataTags();
                document.getElementById('metadataNewTagKey').value = '';
                document.getElementById('metadataNewTagValue').value = '';
            }
        }

        window.removeMetadataTag = function(key) {
            delete window.metadataTags[key];
            renderMetadataTags();
        }

        window.addMetadataKind = function() {
            const kind = document.getElementById('metadataNewKind').value.trim().toLowerCase();

            if (kind && !window.metadataKinds.includes(kind)) {
                window.metadataKinds.push(kind);
                renderMetadataKinds();
                document.getElementById('metadataNewKind').value = '';
            }
        }

        window.removeMetadataKind = function(kind) {
            window.metadataKinds = window.metadataKinds.filter(k => k !== kind);
            renderMetadataKinds();
        }

        async function saveMetadata() {
            try {
                const tool = document.getElementById('metadataTool').value;
                const name = document.getElementById('metadataPipelineName').value;

                const owners = document.getElementById('metadataOwners').value
                    .split(',')
                    .map(o => o.trim())
                    .filter(o => o);

                const data = {
                    enabled: document.getElementById('metadataEnabled').checked,
                    description: document.getElementById('metadataDescription').value || null,
                    group_name: document.getElementById('metadataGroupName').value || 'default',
                    owners: owners.length > 0 ? owners : null,
                    tags: Object.keys(window.metadataTags).length > 0 ? window.metadataTags : null,
                    kinds: window.metadataKinds.length > 0 ? window.metadataKinds : null,
                    retries: parseInt(document.getElementById('metadataRetries').value) || 2,
                    retry_delay: parseInt(document.getElementById('metadataRetryDelay').value) || 30,
                    retry_backoff: document.getElementById('metadataRetryBackoff').value || 'LINEAR',
                    retry_jitter: document.getElementById('metadataRetryJitter').value || null
                };

                await apiCall(`/api/pipelines/${tool}/${name}/metadata`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                showAlert('Metadata updated successfully', 'success');
                closeModal('editMetadataModal');
                await loadPipelines();
                await loadGitStatus();
            } catch (error) {
                console.error('Error saving metadata:', error);
                showAlert('Error saving metadata', 'error');
            }
        }

        // Load git status
        // Check if local repo is behind remote
        async function checkGitSync() {
            try {
                const status = await apiCall('/api/git/status', { showAlert: false });

                if (status.is_behind && status.can_pull) {
                    // Show sync button
                    const syncBtn = document.getElementById('gitSyncBtn');
                    const commitsBehind = document.getElementById('commitsBehind');
                    if (syncBtn && commitsBehind) {
                        commitsBehind.textContent = status.commits_behind;
                        syncBtn.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error checking git sync:', error);
            }
        }

        window.syncFromGitHub = async function() {
            try {
                const result = await apiCall('/api/git/pull', { method: 'POST' });
                if (result.success) {
                    showAlert(result.message, 'success');
                    // Hide sync button
                    document.getElementById('gitSyncBtn').style.display = 'none';
                    // Reload pipelines
                    await loadPipelines();
                }
            } catch (error) {
                showAlert('Failed to pull changes: ' + error.message, 'error');
            }
        }

        async function loadGitStatus() {
            const container = document.getElementById('gitStatus');
            try {
                const status = await apiCall('/api/git/status', { showAlert: false });

                if (!status.is_repo) {
                    container.innerHTML = '<p style="color: #999;">Not a git repository</p>';
                    return;
                }

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Branch:</strong> ${status.branch}<br>
                        <strong>Status:</strong> ${status.is_dirty ? '<span style="color: #e74c3c;">Uncommitted changes</span>' : '<span style="color: #27ae60;">Clean</span>'}<br>
                        ${status.untracked_files.length > 0 ? `<strong>Untracked files:</strong> ${status.untracked_files.length}` : ''}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading git status:', error);
                container.innerHTML = `
                    <p style="color: #e74c3c;">‚ö†Ô∏è Error loading git status: ${error.message}</p>
                    <button onclick="loadGitStatus()" class="btn-outline btn-small" style="margin-top: 10px;">Retry</button>
                `;
            }
        }

        async function loadGitStatusInModal() {
            try {
                const status = await apiCall('/api/git/status');
                const container = document.getElementById('gitModalDetails');
                const actionsSection = document.getElementById('gitActionsSection');

                if (!status.is_repo) {
                    actionsSection.style.display = 'none';
                    container.innerHTML = `
                        <p style="color: #64748b; margin-bottom: 24px; font-size: 0.95em;">No git repository detected. Choose a setup option below:</p>

                        <div style="display: grid; gap: 16px;">
                            <div style="background: white; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.2s;">
                                <h3 style="margin: 0 0 8px 0; font-size: 1em; font-weight: 600; color: #1a202c;">üìÇ Create New Local Repository</h3>
                                <p style="color: #64748b; margin-bottom: 16px; font-size: 0.875em;">Initialize a new git repository in this directory</p>
                                <button onclick="gitInit()" class="btn-success" style="width: 100%; justify-content: center;">
                                    Create Local Repo
                                </button>
                            </div>

                            <div style="background: white; padding: 20px; border: 2px solid #e2e8f0; border-radius: 12px; transition: all 0.2s;">
                                <h3 style="margin: 0 0 8px 0; font-size: 1em; font-weight: 600; color: #1a202c;">üåê Clone Existing Repository</h3>
                                <p style="color: #64748b; margin-bottom: 12px; font-size: 0.875em;">Clone a repository from GitHub</p>
                                <input type="text" id="cloneUrl" placeholder="https://github.com/user/repo.git"
                                    style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em;">
                                <button onclick="gitClone()" class="btn-success" style="width: 100%; justify-content: center;">
                                    Clone Repository
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                // Show/hide sections based on changes
                const diffSection = document.getElementById('gitDiffSection');
                const commitSection = document.getElementById('gitCommitSection');

                if (status.is_dirty) {
                    actionsSection.style.display = 'block';
                    diffSection.style.display = 'block';
                    commitSection.style.display = 'block';
                    loadGitDiff();
                } else {
                    actionsSection.style.display = 'none';
                    diffSection.style.display = 'none';
                    commitSection.style.display = 'none';
                }

                // Always load commit history
                loadGitHistory();

                const remoteHtml = status.has_remote
                    ? '<span style="color: #10b981;">‚úì Configured</span>'
                    : `<span style="color: #f59e0b;">‚ö† Not configured</span> <button onclick="showAddRemoteForm()" style="margin-left: 8px; padding: 4px 12px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em;">Add Remote</button>`;

                const statusColor = status.is_dirty ? '#ef4444' : '#10b981';
                const statusIcon = status.is_dirty ? '‚óè' : '‚úì';
                const statusText = status.is_dirty ? 'Uncommitted changes' : 'Clean';

                container.innerHTML = `
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <span style="color: #64748b; font-size: 0.9em;">Branch</span>
                            <strong style="color: #1a202c;">${status.branch}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <span style="color: #64748b; font-size: 0.9em;">Status</span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${statusText}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <span style="color: #64748b; font-size: 0.9em;">Remote</span>
                            <span>${remoteHtml}</span>
                        </div>
                        ${status.untracked_files.length > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <span style="color: #64748b; font-size: 0.9em;">Untracked files</span>
                            <strong style="color: #f59e0b;">${status.untracked_files.length}</strong>
                        </div>
                        ` : ''}
                    </div>
                    <div id="addRemoteForm" style="display: none; margin-top: 16px; padding: 16px; background: white; border-radius: 12px; border: 2px solid #e2e8f0;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1a202c; font-size: 0.9em;">Remote URL:</label>
                        <input type="text" id="remoteUrl" placeholder="https://github.com/user/repo.git"
                            style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.9em;">
                        <button onclick="gitAddRemote()" class="btn-success" style="width: 100%; justify-content: center;">
                            Add Remote
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading git status:', error);
            }
        }

        function showAddRemoteForm() {
            document.getElementById('addRemoteForm').style.display = 'block';
        }

        // Git operations
        async function gitInit() {
            try {
                await apiCall('/api/git/init', {method: 'POST'});
                showAlert('Git repository initialized successfully', 'success');
                await loadGitStatusInModal();
                await loadGitStatus();
            } catch (error) {
                console.error('Error initializing git:', error);
            }
        }

        async function gitClone() {
            const url = document.getElementById('cloneUrl').value;
            if (!url) {
                showAlert('Please enter a repository URL', 'error');
                return;
            }

            try {
                await apiCall('/api/git/clone', {
                    method: 'POST',
                    body: JSON.stringify({repo_url: url})
                });
                showAlert('Repository cloned successfully. Please refresh the page.', 'success');
                await loadGitStatusInModal();
                await loadGitStatus();
                await loadPipelines();
            } catch (error) {
                console.error('Error cloning repository:', error);
            }
        }

        async function gitAddRemote() {
            const url = document.getElementById('remoteUrl').value;
            if (!url) {
                showAlert('Please enter a remote URL', 'error');
                return;
            }

            try {
                await apiCall('/api/git/add-remote', {
                    method: 'POST',
                    body: JSON.stringify({remote_url: url, remote_name: 'origin'})
                });
                showAlert('Remote added successfully', 'success');
                document.getElementById('addRemoteForm').style.display = 'none';
                await loadGitStatusInModal();
                await loadGitStatus();
            } catch (error) {
                console.error('Error adding remote:', error);
            }
        }

        // Check for unsynced environment variables
        async function checkEnvVarsBeforeGitOp() {
            try {
                const data = await apiCall('/api/env', { showAlert: false });
                const unsetVars = Object.entries(data.variables)
                    .filter(([key, value]) => value === '' || value === '********')
                    .map(([key]) => key);

                if (unsetVars.length > 0) {
                    const varList = unsetVars.join(', ');
                    const proceed = confirm(
                        `‚ö†Ô∏è WARNING: The following environment variables are not set:\n\n${varList}\n\n` +
                        `These pipelines may fail in Dagster+ until you:\n` +
                        `1. Set local values in Environment Variables\n` +
                        `2. Sync to Dagster+ with production values\n\n` +
                        `Do you want to continue anyway?`
                    );
                    return proceed;
                }

                return true;
            } catch (error) {
                console.error('Error checking env vars:', error);
                return true; // Continue on error
            }
        }

        async function gitCommit() {
            const proceed = await checkEnvVarsBeforeGitOp();
            if (!proceed) return;

            const message = prompt('Commit message:', 'Update pipelines');
            if (!message) return;

            try {
                await apiCall('/api/git/commit', {
                    method: 'POST',
                    body: JSON.stringify({message})
                });
                showAlert('Changes committed successfully', 'success');
                await loadGitStatusInModal();
                await loadGitStatus();
            } catch (error) {
                console.error('Error committing changes:', error);
            }
        }

        async function gitPush() {
            const proceed = await checkEnvVarsBeforeGitOp();
            if (!proceed) return;

            try {
                await apiCall('/api/git/push', {method: 'POST'});
                showAlert('Changes pushed to remote', 'success');
                await loadGitStatusInModal();
                await loadGitStatus();
            } catch (error) {
                console.error('Error pushing changes:', error);
            }
        }

        async function loadGitDiff() {
            try {
                const diff = await apiCall('/api/git/diff', { showAlert: false });
                const container = document.getElementById('gitDiffContent');

                let diffText = '';
                if (diff.unstaged) diffText += diff.unstaged;
                if (diff.staged) diffText += (diffText ? '\n\n' : '') + diff.staged;

                if (diff.untracked && diff.untracked.length > 0) {
                    diffText += (diffText ? '\n\n' : '') + '## Untracked files:\n' + diff.untracked.map(f => `+ ${f}`).join('\n');
                }

                if (!diffText) {
                    diffText = 'No changes to display';
                }

                container.textContent = diffText;
            } catch (error) {
                console.error('Error loading git diff:', error);
                document.getElementById('gitDiffContent').textContent = 'Error loading diff';
            }
        }

        async function loadGitHistory() {
            try {
                const data = await apiCall('/api/git/log?limit=10', { showAlert: false });
                const container = document.getElementById('gitHistoryContent');

                if (!data.commits || data.commits.length === 0) {
                    container.innerHTML = '<p style="padding: 16px; color: #64748b; text-align: center;">No commits yet</p>';
                    return;
                }

                container.innerHTML = data.commits.map(commit => `
                    <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; transition: background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                            <code style="background: #e2e8f0; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; color: #475569;">${commit.sha}</code>
                            <span style="color: #94a3b8; font-size: 0.8em;">${new Date(commit.date).toLocaleString()}</span>
                        </div>
                        <div style="color: #1e293b; font-size: 0.9em; margin: 4px 0;">${commit.message}</div>
                        <div style="color: #64748b; font-size: 0.8em;">${commit.author}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading git history:', error);
                document.getElementById('gitHistoryContent').innerHTML = '<p style="padding: 16px; color: #dc2626;">Error loading commit history</p>';
            }
        }

        async function gitCommitWithMessage() {
            const proceed = await checkEnvVarsBeforeGitOp();
            if (!proceed) return;

            const message = document.getElementById('gitCommitMessage').value.trim();
            if (!message) {
                showAlert('Please enter a commit message', 'error');
                return;
            }

            try {
                await apiCall('/api/git/commit', {
                    method: 'POST',
                    body: JSON.stringify({message})
                });
                showAlert('Changes committed successfully', 'success');
                document.getElementById('gitCommitMessage').value = '';
                await loadGitStatusInModal();
                await loadGitStatus();
                await loadGitDiff();
                await loadGitHistory();
            } catch (error) {
                console.error('Error committing changes:', error);
            }
        }

        async function gitRevert() {
            if (!confirm('‚ö†Ô∏è This will discard ALL uncommitted changes. This cannot be undone. Continue?')) {
                return;
            }

            try {
                await apiCall('/api/git/revert', {method: 'POST'});
                showAlert('All changes reverted', 'success');
                await loadGitStatusInModal();
                await loadGitStatus();
                await loadGitDiff();
            } catch (error) {
                console.error('Error reverting changes:', error);
            }
        }

        // Credentials testing
        async function loadCredentialOptions() {
            const select = document.getElementById('testSourceType');
            const sources = await apiCall('/api/sources');
            const destinations = await apiCall('/api/destinations');

            // Add sources
            const sourceGroup = document.createElement('optgroup');
            sourceGroup.label = 'Sources';
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = `source:${source}`;
                option.textContent = source;
                sourceGroup.appendChild(option);
            });
            select.appendChild(sourceGroup);

            // Add destinations
            const destGroup = document.createElement('optgroup');
            destGroup.label = 'Destinations';
            destinations.forEach(dest => {
                const option = document.createElement('option');
                option.value = `destination:${dest}`;
                option.textContent = dest;
                destGroup.appendChild(option);
            });
            select.appendChild(destGroup);
        }

        async function loadCredentialFields() {
            const select = document.getElementById('testSourceType');
            const value = select.value;

            if (!value) {
                document.getElementById('credentialFields').innerHTML = '';
                return;
            }

            const [type, name] = value.split(':');

            try {
                const credentials = await apiCall(`/api/credentials/${name}`);
                const container = document.getElementById('credentialFields');

                container.innerHTML = '<h3 style="margin: 20px 0 15px;">Enter Credentials</h3>';

                // Use createCredentialField helper to support all field types (including select)
                credentials.forEach(cred => {
                    // Pass empty prefix so field names are just the key
                    const fieldDiv = createCredentialField(cred, '');
                    container.appendChild(fieldDiv);
                });

                // Update conditional fields after all fields are rendered
                updateConditionalFields(container);

            } catch (error) {
                console.error('Error loading credential fields:', error);
            }
        }

        async function testCredentials() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div class="loading">Testing connection...</div>';
            resultDiv.classList.remove('hidden');

            // Simulate test (would need backend endpoint)
            setTimeout(() => {
                resultDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚ÑπÔ∏è Testing Not Implemented</strong><br>
                        Credential testing requires backend validation. For now, these values would be saved to your .env file.
                    </div>
                `;
            }, 1000);
        }

        // Event listeners
        const sourceTypeEl = document.getElementById('sourceType');
        const destTypeEl = document.getElementById('destinationType');

        if (sourceTypeEl) {
            sourceTypeEl.addEventListener('change', async (e) => {
                await loadSourceConfiguration(e.target.value);
                await updateToolRecommendation();
                autoPopulateKinds();
            });
        } else {
            console.error('sourceType element not found');
        }

        if (destTypeEl) {
            destTypeEl.addEventListener('change', async () => {
                await updateToolRecommendation();
                autoPopulateKinds();
                updateFileFormatVisibility();
            });
        } else {
            console.error('destinationType element not found');
        }

        // Show/hide file format section based on destination type
        function updateFileFormatVisibility() {
            const destType = document.getElementById('destinationType')?.value;
            const fileFormatSection = document.getElementById('fileFormatSection');
            const advancedDestSection = document.getElementById('advancedDestinationSection');

            // Show file format options for file-based destinations
            const fileBasedDestinations = ['filesystem', 'duckdb', 'motherduck', 's3', 'gcs', 'azure'];
            if (fileFormatSection) {
                fileFormatSection.style.display = fileBasedDestinations.includes(destType) ? 'block' : 'none';
            }

            // Show advanced settings for warehouse and database destinations
            const warehouseDestinations = [
                'snowflake', 'bigquery', 'redshift', 'databricks',
                'postgres', 'mysql', 'mssql', 'clickhouse', 'trino',
                'duckdb', 'motherduck'
            ];
            if (advancedDestSection) {
                advancedDestSection.style.display = warehouseDestinations.includes(destType) ? 'block' : 'none';
            }
        }

        // Close modal on outside click
        window.onclick = function(event) {
            if (event.target && event.target.classList && event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        // Expose functions globally for onclick handlers
        window.openCreatePipelineModal = openCreatePipelineModal;
        window.openGitModal = openGitModal;
        window.openEnvModal = openEnvModal;
        window.openCredentialsModal = openCredentialsModal;
        window.openSettingsModal = openSettingsModal;
        window.browseDirectory = browseDirectory;
        window.selectRepoPath = selectRepoPath;
        window.validateManualPath = validateManualPath;
        window.applyRepoPath = applyRepoPath;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.loadPipelines = loadPipelines;
        window.submitPipeline = submitPipeline;
        window.editPipeline = editPipeline;
        window.deletePipeline = deletePipeline;
        window.editMetadata = editMetadata;
        window.saveMetadata = saveMetadata;
        window.addMetadataTag = addMetadataTag;
        window.removeMetadataTag = removeMetadataTag;
        window.addMetadataKind = addMetadataKind;
        window.removeMetadataKind = removeMetadataKind;
        window.togglePipelineEnabled = togglePipelineEnabled;
        window.updateScheduleUI = updateScheduleUI;
        window.updateCronFromPreset = updateCronFromPreset;
        window.updateCustomScheduleFields = updateCustomScheduleFields;
        window.updateCronFromCustom = updateCronFromCustom;
        window.addEnvVar = addEnvVar;
        window.deleteEnvVar = deleteEnvVar;
        window.syncSingleVarToDagsterPlus = syncSingleVarToDagsterPlus;
        window.showDagsterValueInputs = showDagsterValueInputs;
        window.gitCommit = gitCommit;
        window.gitPush = gitPush;
        window.gitInit = gitInit;
        window.gitClone = gitClone;
        window.gitAddRemote = gitAddRemote;
        window.showAddRemoteForm = showAddRemoteForm;
        window.loadCredentialFields = loadCredentialFields;
        window.testCredentials = testCredentials;
        window.loadCredentialInputFields = loadCredentialInputFields;
        window.toggleDarkMode = toggleDarkMode;
        window.toggleIconMode = toggleIconMode;

        // Initialize
        (async function init() {
            // Load UI preferences first (dark mode, icon mode)
            loadUIPreferences();

            console.log('Initializing ELT Builder UI...');
            console.log('Checking DOM elements...');
            console.log('sourceType exists?', !!document.getElementById('sourceType'));
            console.log('destinationType exists?', !!document.getElementById('destinationType'));
            console.log('pipelinesContainer exists?', !!document.getElementById('pipelinesContainer'));
            console.log('gitStatus exists?', !!document.getElementById('gitStatus'));

            try {
                console.log('Loading sources and destinations...');
                await loadSourcesAndDestinations();
                console.log('Sources and destinations loaded');
            } catch (error) {
                console.error('Failed to load sources/destinations:', error);
            }

            try {
                console.log('Loading pipelines...');
                await loadPipelines();
                console.log('Pipelines loaded');
            } catch (error) {
                console.error('Failed to load pipelines:', error);
            }

            try {
                console.log('Loading git status...');
                await loadGitStatus();
                console.log('Git status loaded');
            } catch (error) {
                console.error('Failed to load git status:', error);
            }

            try {
                console.log('Checking git sync status...');
                await checkGitSync();
                console.log('Git sync status checked');
            } catch (error) {
                console.error('Failed to check git sync:', error);
            }

            console.log('Initialization complete');
        })();

        } // End of initializeApp
    </script>
</body>
</html>
